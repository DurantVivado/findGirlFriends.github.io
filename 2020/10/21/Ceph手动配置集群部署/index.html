

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&quot;auto&quot;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="博主：来自华中科技大学国家光电研究中心的">
  <meta name="author" content="Durant">
  <meta name="keywords" content="">
  <title>【高级部署】Ceph手动配置集群部署&amp;编译源码 - Durant Thorvalds 的米奇妙妙屋</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/gitalk/1.6.2/gitalk.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_pf9vaxs7x7b.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                联系我
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-10-21 00:00" pubdate>
        2020年10月21日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      22.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      300
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">【高级部署】Ceph手动配置集群部署&amp;编译源码</h1>
            
            <div class="markdown-body" id="post-body">
              <div class="note note-primary">
            <p>TODO: 最近一次更新 : 2020/11/26 21:11</p>
          </div>
<h1 id="当前最流行的分布式存储系统——Ceph尝鲜"><a href="#当前最流行的分布式存储系统——Ceph尝鲜" class="headerlink" title="当前最流行的分布式存储系统——Ceph尝鲜"></a>当前最流行的分布式存储系统——Ceph尝鲜</h1><blockquote>
<p>首先介绍一些使用的网站备查，建议保存到chrome收藏夹！</p>
<p><a target="_blank" rel="noopener" href="http://ceph.org.cn/">Ceph中国社区</a>：包括中文文档（非最新），以及新闻等。</p>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/">最新的英文文档</a>：最新的英文文档，包括nautilus和Octopus版本，你一定不想错过！</p>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/api/">API文档</a></p>
<p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/start/quick-start-preflight/#ntp">快速安装入门</a>：适合新手，包括基础的配置等。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/ceph/ceph">Ceph源码</a>：喜欢git的筒子可以看这儿，包括编译步骤。</p>
<p><a target="_blank" rel="noopener" href="https://tracker.ceph.com/">官方的问题tracker</a>：</p>
<p><a target="_blank" rel="noopener" href="https://tracker.ceph.com/projects/ceph/roadmap">官方的roadmap</a>（版本问题）</p>
</blockquote>
<p>你在寻找。。。</p>
<p>源码编译可以直接去 <a href="#here">这儿</a></p>
<p><img src="\img\ceph-logo.png" srcset="/img/loading.gif" alt="Logo"></p>
<h2 id="版本问题"><a href="#版本问题" class="headerlink" title="版本问题"></a>版本问题</h2><ul>
<li>x.0.z - 开发版（给早期测试者和勇士们）</li>
<li>x.1.z - 候选版（用于测试集群、高手们）</li>
<li>x.2.z - 稳定、修正版（给用户们）</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>版本名称</th>
<th>发行时间/EOL</th>
<th>建议的部署工具</th>
</tr>
</thead>
<tbody>
<tr>
<td>Argonaut 　0.48版本(LTS)</td>
<td>2012年6月3日</td>
<td></td>
</tr>
<tr>
<td>Bobtail 　　0.56版本(LTS)</td>
<td>2013年1月1日</td>
<td></td>
</tr>
<tr>
<td>Cuttlefish  0.61版本</td>
<td>2013年5月7日</td>
<td></td>
</tr>
<tr>
<td>Dumpling  0.67版本(LTS)</td>
<td>2013年8月14日</td>
<td></td>
</tr>
<tr>
<td>Emperor 　 0.72版本</td>
<td>2013年11月9日</td>
<td></td>
</tr>
<tr>
<td>Firefly 　　 0.80版本(LTS)</td>
<td>2014年5月</td>
<td></td>
</tr>
<tr>
<td>Giant 　 Stable</td>
<td>October 2014 - April 2015</td>
<td></td>
</tr>
<tr>
<td>Hammer   LTS</td>
<td>April 2015 - November 2016</td>
<td></td>
</tr>
<tr>
<td>Infernalis   Stable</td>
<td>November 2015 - June 2016</td>
<td></td>
</tr>
<tr>
<td>Jewel 10</td>
<td>2016年4月</td>
<td>ceph-deploy</td>
</tr>
<tr>
<td>Kraken 11</td>
<td>2017年10月</td>
<td>ceph-deploy</td>
</tr>
<tr>
<td>Luminous 12</td>
<td>2017年10月</td>
<td>ceph-deploy</td>
</tr>
<tr>
<td>mimic 13</td>
<td>2018年5月</td>
<td>ceph-deploy</td>
</tr>
<tr>
<td>Nautilus 14.2.12</td>
<td>2019年3月 /2021年6月</td>
<td><a target="_blank" rel="noopener" href="https://rook.io/">Rook</a> (Kubernetes-preferred,fully integrated with new orchestration API,  docker-dependent)</td>
</tr>
<tr>
<td>Octopus 15.2.5</td>
<td>2020年3月 /2022年6月</td>
<td><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/cephadm/#cephadm">Cephadm</a>（fully integrated with new orchestration API,  docker-dependent）</td>
</tr>
<tr>
<td>Pacific 16</td>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>获取最新版本信息，详见</p>
<p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/releases/general/">https://docs.ceph.com/en/latest/releases/general/</a></p>
<p>如果你遇到问题，No problem,这儿有一个庞大的社区来协助你：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/community/">Ceph 社区</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/log-and-debug/">日志和调试</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/troubleshooting-mon/">Troubleshooting Monitors</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/troubleshooting-osd/">Troubleshooting OSDs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/troubleshooting-pg/">Troubleshooting PGs</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/memory-profiling/">Memory Profiling</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/troubleshooting/cpu-profiling/">CPU Profiling</a></li>
</ul>
<hr>
<p>硬件支持问题</p>
<h3 id="Ceph硬件要求"><a href="#Ceph硬件要求" class="headerlink" title="Ceph硬件要求"></a>Ceph硬件要求</h3><p>Ceph 为普通硬件设计，这可使构建、维护 PB 级数据集群的费用相对低廉。规划集群硬件时，需要均衡几方面的因素，包括区域失效和潜在的性能问题。硬件规划要包含把使用 Ceph 集群的 Ceph 守护进程和其他进程恰当分布。通常，我们推荐在一台机器上只运行一种类型的守护进程。我们推荐把使用数据集群的进程（如 OpenStack 、 CloudStack 等）安装在别的机器上。</p>
<blockquote>
<p>关于 Ceph 的高品质博客文章也值得参考，比如 <a target="_blank" rel="noopener" href="http://ceph.com/community/ceph-performance-part-1-disk-controller-write-throughput/">Ceph Write Throughput 1</a> 、 <a target="_blank" rel="noopener" href="http://ceph.com/community/ceph-performance-part-2-write-throughput-without-ssd-journals/">Ceph Write Throughput 2</a> 、 <a target="_blank" rel="noopener" href="http://ceph.com/uncategorized/argonaut-vs-bobtail-performance-preview/">Argonaut v. Bobtail Performance Preview</a> 、 <a target="_blank" rel="noopener" href="http://ceph.com/community/ceph-bobtail-performance-io-scheduler-comparison/">Bobtail Performance - I/O Scheduler Comparison</a> 。</p>
</blockquote>
<h4 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h4><p>Ceph 元数据服务器对 CPU 敏感，它会动态地重分布它们的负载，所以你的元数据服务器应该有足够的处理能力（如 4 核或更强悍的 CPU ）。 Ceph 的 OSD 运行着 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-rados"><em>RADOS</em></a> 服务、用 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-crush"><em>CRUSH</em></a> 计算数据存放位置、复制数据、维护它自己的集群运行图副本，因此 OSD 需要一定的处理能力（如双核 CPU ）。监视器只简单地维护着集群运行图的副本，因此对 CPU 不敏感；但必须考虑机器以后是否还会运行 Ceph 监视器以外的 CPU 密集型任务。例如，如果服务器以后要运行用于计算的虚拟机（如 OpenStack Nova ），你就要确保给 Ceph 进程保留了足够的处理能力，所以我们推荐在其他机器上运行 CPU 密集型任务。</p>
<h4 id="RAM内存"><a href="#RAM内存" class="headerlink" title="RAM内存"></a>RAM内存</h4><p>元数据服务器和监视器必须可以尽快地提供它们的数据，所以他们应该有足够的内存，至少每进程 1GB 。 OSD 的日常运行不需要那么多内存（如每进程 500MB ）差不多了；然而在恢复期间它们占用内存比较大（如每进程每 TB 数据需要约 1GB 内存）。通常内存越多越好。</p>
<p>元数据服务器和监视器必须可以尽快地提供它们的数据，所以他们应该有足够的内存，至少每进程 1GB 。 OSD 的日常运行不需要那么多内存（如每进程 500MB ）差不多了；然而在恢复期间它们占用内存比较大（如每进程每 TB 数据需要约 1GB 内存）。通常内存越多越好。</p>
<blockquote>
<p>因为 Ceph 发送 ACK 前必须把所有数据写入日志（至少对 xfs 和 ext4 来说是），因此均衡日志和 OSD 性能相当重要。</p>
</blockquote>
<h4 id="硬盘驱动器"><a href="#硬盘驱动器" class="headerlink" title="硬盘驱动器"></a>硬盘驱动器</h4><p>OSD 应该有足够的空间用于存储对象数据。考虑到大硬盘的每 GB 成本，我们建议用容量大于 1TB 的硬盘。</p>
<ul>
<li><p>不顾分区而在单个硬盘上运行多个OSD，这样<strong>不明智</strong>！</p>
</li>
<li><p>不顾分区而在运行了OSD的硬盘上同时运行监视器或元数据服务器也<strong>不明智</strong>！</p>
</li>
</ul>
<p>存储驱动器受限于寻道时间、访问时间、读写时间、还有总吞吐量，这些物理局限性影响着整体系统性能，尤其在系统恢复期间。因此我们推荐独立的驱动器用于安装操作系统和软件，另外每个 OSD 守护进程占用一个驱动器。大多数 “slow OSD”问题的起因都是在相同的硬盘上运行了操作系统、多个 OSD 、和/或多个日志文件。鉴于解决性能问题的成本差不多会超过另外增加磁盘驱动器，你应该在设计时就避免增加 OSD 存储驱动器的负担来提升性能。</p>
<p>Ceph 允许你在每块硬盘驱动器上运行多个 OSD ，但这会导致资源竞争并降低总体吞吐量； Ceph 也允许把日志和对象数据存储在相同驱动器上，但这会增加记录写日志并回应客户端的延时，因为 Ceph 必须先写入日志才会回应确认了写动作。 btrfs 文件系统能同时写入日志数据和对象数据， xfs 和 ext4 却不能。</p>
<p>SSD总体性能优于HDD</p>
<ul>
<li><strong>写密集语义：</strong> 记日志涉及写密集语义，所以你要确保选用的 SSD 写入性能和硬盘相当或好于硬盘。廉价 SSD 可能在加速访问的同时引入写延时，有时候高性能硬盘的写入速度可以和便宜 SSD 相媲美。</li>
<li><strong>顺序写入：</strong> 在一个 SSD 上为多个 OSD 存储多个日志时也必须考虑 SSD 的顺序写入极限，因为它们要同时处理多个 OSD 日志的写入请求。</li>
<li><strong>分区对齐：</strong> 采用了 SSD 的一个常见问题是人们喜欢分区，却常常忽略了分区对齐，这会导致 SSD 的数据传输速率慢很多，所以请确保分区对齐了。</li>
</ul>
<p>SSD 用于对象存储太昂贵了，但是把 OSD 的日志存到 SSD 、把对象数据存储到独立的硬盘可以明显提升性能。 <code>osd journal</code> 选项的默认值是 <code>/var/lib/ceph/osd/$cluster-$id/journal</code> ，你可以把它挂载到一个 SSD 或 SSD 分区，这样它就不再是和对象数据一样存储在同一个硬盘上的文件了。</p>
<p>提升 CephFS 文件系统性能的一种方法是从 CephFS 文件内容里分离出元数据。 Ceph 提供了默认的 <code>metadata</code> 存储池来存储 CephFS 元数据，所以你不需要给 CephFS 元数据创建存储池，但是可以给它创建一个仅指向某主机 SSD 的 CRUSH 运行图。详情见<a target="_blank" rel="noopener" href="http://ceph.com/docs/master/rados/operations/crush-map/#placing-different-pools-on-different-osds">给存储池指定 OSD</a> 。</p>
<p>你可以在同一主机上运行多个 OSD ，但要确保 OSD 硬盘总吞吐量不超过为客户端提供读写服务所需的网络带宽；还要考虑集群在每台主机上所存储的数据占总体的百分比，如果一台主机所占百分比太大而它挂了，就可能导致诸如超过 <code>full ratio</code> 的问题，此问题会使 Ceph 中止运作以防数据丢失。</p>
<p>如果每台主机运行多个 OSD ，也得保证内核是最新的。参阅<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/start/os-recommendations">操作系统推荐</a>里关于 <code>glibc</code> 和 <code>syncfs(2)</code> 的部分，确保硬件性能可达期望值。</p>
<p>OSD 数量较多（如 20 个以上）的主机会派生出大量线程，尤其是在恢复和重均衡期间。很多 Linux 内核默认的最大线程数较小（如 32k 个），如果您遇到了这类问题，可以把 <code>kernel.pid_max</code> 值调高些。理论最大值是 4194303 。例如把下列这行加入 <code>/etc/sysctl.conf</code> 文件：</p>
<pre><code class="hljs ini"><span class="hljs-attr">kernel.pid_max</span> = <span class="hljs-number">4194303</span></code></pre>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p>​        建议每台机器最少两个千兆网卡，现在大多数机械硬盘都能达到大概 100MB/s 的吞吐量，网卡应该能处理所有 OSD 硬盘总吞吐量，所以推荐最少两个千兆网卡，分别用于公网（前端）和集群网络（后端）。集群网络（最好别连接到国际互联网）用于处理由数据复制产生的额外负载，而且可防止拒绝服务攻击，拒绝服务攻击会干扰数据归置组，使之在 OSD 数据复制时不能回到 <code>active + clean</code> 状态。请考虑部署万兆网卡。通过 1Gbps 网络复制 1TB 数据耗时 3 小时，而 3TB （典型配置）需要 9 小时，相比之下，如果使用 10Gbps 复制时间可分别缩减到 20 分钟和 1 小时。在一个 PB 级集群中， OSD 磁盘失败是常态，而非异常；在性价比合理的的前提下，系统管理员想让 PG 尽快从 <code>degraded</code> （降级）状态恢复到 <code>active + clean</code> 状态。另外，一些部署工具（如 Dell 的 Crowbar ）部署了 5 个不同的网络，但使用了 VLAN 以提高网络和硬件可管理性。 VLAN 使用 802.1q 协议，还需要采用支持 VLAN 功能的网卡和交换机，增加的硬件成本可用节省的运营（网络安装、维护）成本抵消。使用 VLAN 来处理集群和计算栈（如 OpenStack 、 CloudStack 等等）之间的 VM 流量时，采用 10G 网卡仍然值得。每个网络的机架路由器到核心路由器应该有更大的带宽，如 40Gbps 到 100Gbps 。</p>
<p>​        服务器应配置底板管理控制器（ Baseboard Management Controller, BMC ），管理和部署工具也应该大规模使用 BMC ，所以请考虑带外网络管理的成本/效益平衡，此程序管理着 SSH 访问、 VM 映像上传、操作系统安装、端口管理、等等，会徒增网络负载。运营 3 个网络有点过分，但是每条流量路径都指示了部署一个大型数据集群前要仔细考虑的潜能力、吞吐量、性能瓶颈。</p>
<p>Ceph 可以运行在廉价的普通硬件上，小型生产集群和开发集群可以在一般的硬件上。</p>
<p>如果在只有一块硬盘的机器上运行 OSD ，要把数据和操作系统分别放到不同分区；一般来说，我们推荐操作系统和数据分别使用不同的硬盘。</p>
<h4 id="最低硬件要求"><a href="#最低硬件要求" class="headerlink" title="最低硬件要求"></a>最低硬件要求</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">进程</th>
<th style="text-align:left">条件</th>
<th style="text-align:left">最低建议</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>ceph-osd</code></td>
<td style="text-align:left">Processor</td>
<td style="text-align:left">1x 64-bit AMD-641x 32-bit ARM dual-core or better1x i386 dual-core</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RAM</td>
<td style="text-align:left">~1GB for 1TB of storage per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Volume Storage</td>
<td style="text-align:left">1x storage drive per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Journal</td>
<td style="text-align:left">1x SSD partition per daemon (optional)</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"><code>ceph-mon</code></td>
<td style="text-align:left">Processor</td>
<td style="text-align:left">1x 64-bit AMD-64/i3861x 32-bit ARM dual-core or better1x i386 dual-core</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RAM</td>
<td style="text-align:left">1 GB per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Disk Space</td>
<td style="text-align:left">10 GB per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"><code>ceph-mds</code></td>
<td style="text-align:left">Processor</td>
<td style="text-align:left">1x 64-bit AMD-64 quad-core1x 32-bit ARM quad-core1x i386 quad-core</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RAM</td>
<td style="text-align:left">1 GB minimum per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Disk Space</td>
<td style="text-align:left">1 MB per daemon</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
</tbody>
</table>
</div>
<h4 id="生产实例"><a href="#生产实例" class="headerlink" title="生产实例"></a>生产实例</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Configuration</th>
<th style="text-align:left">Criteria</th>
<th style="text-align:left">Minimum Recommended</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Dell PE R510</td>
<td style="text-align:left">Processor</td>
<td style="text-align:left">2x 64-bit quad-core Xeon CPUs</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RAM</td>
<td style="text-align:left">16 GB</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Volume Storage</td>
<td style="text-align:left">8x 2TB drives. 1 OS, 7 Storage</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Client Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">OSD Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Mgmt. Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left">Dell PE R515</td>
<td style="text-align:left">Processor</td>
<td style="text-align:left">1x hex-core Opteron CPU</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">RAM</td>
<td style="text-align:left">16 GB</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Volume Storage</td>
<td style="text-align:left">12x 3TB drives. Storage</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">OS Storage</td>
<td style="text-align:left">1x 500GB drive. Operating System.</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Client Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">OSD Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
<tr>
<td style="text-align:left"></td>
<td style="text-align:left">Mgmt. Network</td>
<td style="text-align:left">2x 1GB Ethernet NICs</td>
</tr>
</tbody>
</table>
</div>
<p>当然如果你想更加细致的开发ceph，建议进行<strong>手动部署</strong>！</p>
<h1 id="A-Manual-Deploymeny手动部署💪"><a href="#A-Manual-Deploymeny手动部署💪" class="headerlink" title="A. Manual Deploymeny手动部署💪"></a>A. <em>Manual Deploymeny</em>手动部署💪</h1><h2 id="1-部署ceph-mon"><a href="#1-部署ceph-mon" class="headerlink" title="1. 部署ceph-mon"></a>1. 部署ceph-mon</h2><p>安装完成之后在<code>/etc/ceph</code>目录下新建文件<code>ceph.conf</code>，内容大致如下，根据实际情况进行修改即可：</p>
<pre><code class="hljs routeros">[global]
fsid = &#123;cluster-id&#125;
mon initial members = &#123;hostname&#125;[, &#123;hostname&#125;]
mon host = &#123;ip-address&#125;[, &#123;ip-address&#125;]
public<span class="hljs-built_in"> network </span>= &#123;network&#125;[, &#123;network&#125;]
cluster<span class="hljs-built_in"> network </span>= &#123;network&#125;[, &#123;network&#125;]
auth cluster required = cephx
auth<span class="hljs-built_in"> service </span>required = cephx
auth<span class="hljs-built_in"> client </span>required = cephx
osd journal size = &#123;n&#125;
osd<span class="hljs-built_in"> pool default </span>size = &#123;n&#125;  # Write an object n times.
osd<span class="hljs-built_in"> pool default </span>min size = &#123;n&#125; # Allow writing n copies <span class="hljs-keyword">in</span> a degraded state.
osd<span class="hljs-built_in"> pool default </span>pg num = &#123;n&#125;
osd<span class="hljs-built_in"> pool default </span>pgp num = &#123;n&#125;
osd crush chooseleaf<span class="hljs-built_in"> type </span>= &#123;n&#125;
</code></pre>
<p>为监控节点创建密钥：</p>
<pre><code class="hljs shell">ceph-authtool --create-keyring /etc/ceph/ceph.mon.keyring --gen-key -n mon. --cap mon &#x27;allow *&#x27;</code></pre>
<p>创建client.admin用户并创建密钥：</p>
<pre><code class="hljs shell">ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --cap mon &#x27;allow *&#x27; --cap osd &#x27;allow *&#x27; --cap mds &#x27;allow *&#x27; --cap mgr &#x27;allow *&#x27;</code></pre>
<p>创建client.bootstrap-osd用户并创建密钥：</p>
<pre><code class="hljs shell">ceph-authtool --create-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon &#x27;profile bootstrap-osd&#x27;</code></pre>
<p>将刚才生成的两个密钥加入ceph.mon.keyring中：</p>
<pre><code class="hljs shell">ceph-authtool /etc/ceph/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
ceph-authtool /etc/ceph/ceph.mon.keyring --import-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring</code></pre>
<p>此时ceph.mon.keyring中应有如下密钥：</p>
<pre><code class="hljs nix">[mon.]
	<span class="hljs-attr">key</span> = AQBWAa1f8zAHJBAAf0cyxMAZjsZeL7+x+<span class="hljs-attr">czsLw==</span>
	caps <span class="hljs-attr">mon</span> = <span class="hljs-string">&quot;allow *&quot;</span>
[client.admin]
	<span class="hljs-attr">key</span> = AQDPAa1fxm0VMRAAXMJ+<span class="hljs-attr">QU7sA9knr5ZWsluLxg==</span>
	caps <span class="hljs-attr">mds</span> = <span class="hljs-string">&quot;allow *&quot;</span>
	caps <span class="hljs-attr">mgr</span> = <span class="hljs-string">&quot;allow *&quot;</span>
	caps <span class="hljs-attr">mon</span> = <span class="hljs-string">&quot;allow *&quot;</span>
	caps <span class="hljs-attr">osd</span> = <span class="hljs-string">&quot;allow *&quot;</span>
[client.bootstrap-osd]
	<span class="hljs-attr">key</span> = AQAWAq1fATC1ChAAb2wMiO+k/<span class="hljs-attr">hwlMEmddDLAcg==</span>
	caps <span class="hljs-attr">mgr</span> = <span class="hljs-string">&quot;allow r&quot;</span>
	caps <span class="hljs-attr">mon</span> = <span class="hljs-string">&quot;profile bootstrap-osd&quot;</span></code></pre>
<p>生成监控映射：</p>
<pre><code class="hljs shell">monmaptool --create --add &#123;hostname&#125; &#123;ip-address&#125; --fsid &#123;uuid&#125; /etc/ceph/monmap
</code></pre>
<p>创建默认的数据目录，其中目录名是{cluster-name}-{hostname}格式：</p>
<pre><code class="hljs shell">sudo mkdir /var/lib/ceph/mon/&#123;cluster-name&#125;-&#123;hostname&#125;
</code></pre>
<p>创建守护进程：</p>
<pre><code class="hljs shell">sudo ceph-mon [--cluster &#123;cluster-name&#125;] --mkfs -i &#123;hostname&#125; --monmap /etc/ceph/monmap --keyring /etc/ceph/ceph.mon.keyring</code></pre>
<p>启动mon：</p>
<pre><code class="hljs shell">ceph-mon -i &#123;hostname&#125; -c /etc/ceph/ceph.conf --cluster ceph</code></pre>
<p>这儿不能根据官方推荐的systemctl。 </p>
<p>之后我们用 </p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph -s</span></code></pre>
<p>查看集群</p>
<p>这里笔者遇到问题：</p>
<pre><code class="hljs pgsql">[errno <span class="hljs-number">2</span>] RADOS <span class="hljs-keyword">object</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">found</span> (error connecting <span class="hljs-keyword">to</span> the <span class="hljs-keyword">cluster</span>)</code></pre>
<p>提示RADOS对象没有找到，但是我还没有到那一步呢！</p>
<p>原来是没有加sudo</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">sudo ceph -s</span></code></pre>
<pre><code class="hljs yaml"><span class="hljs-attr">cluster:</span>
  <span class="hljs-attr">id:</span>     <span class="hljs-string">250a1431-6cf3-4d0b-a964-361cd8d10dad</span>
  <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_WARN</span>
          <span class="hljs-number">1</span> <span class="hljs-string">monitors</span> <span class="hljs-string">have</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">msgr2</span>
 
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mon:</span> <span class="hljs-number">1</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph-master</span> <span class="hljs-string">(age</span> <span class="hljs-string">25m)</span>
  <span class="hljs-attr">mgr:</span> <span class="hljs-literal">no</span> <span class="hljs-string">daemons</span> <span class="hljs-string">active</span>
  <span class="hljs-attr">osd: 0 osds:</span> <span class="hljs-number">0</span> <span class="hljs-string">up,</span> <span class="hljs-number">0</span> <span class="hljs-string">in</span>
 
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span>
  <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span> <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span>
  <span class="hljs-attr">usage:</span>   <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">used,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">/</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">avail</span>
  <span class="hljs-attr">pgs:</span></code></pre>
<p>这是最<strong>基本</strong>的集群，所以只有一个monitor，马上我们就进行必要的扩展！</p>
<p>这儿有一个 <code>HEALTH_WARN</code>大家应该注意到了，这是因为 msgr 没有enable。</p>
<pre><code class="hljs routeros">sudo ceph<span class="hljs-built_in"> health </span>detail #详细查看健康状况</code></pre>
<h2 id="2-部署ceph-mgr"><a href="#2-部署ceph-mgr" class="headerlink" title="2. 部署ceph-mgr"></a>2. 部署ceph-mgr</h2><p>前面我们说每一个mon节点最好加一个mgr守护进程。名字叫<code>open-stack</code></p>
<h2 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h2><p>创建用户 openstack 用于 MGR 监控</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">auth </span><span class="hljs-built_in">get-or-create</span> <span class="hljs-string">mgr.</span><span class="hljs-string">openstack </span><span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-string">osd </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-string">mds </span><span class="hljs-string">&#x27;allow *&#x27;</span> [<span class="hljs-string">mgr.</span><span class="hljs-string">openstack]</span> <span class="hljs-string">key </span>= <span class="hljs-string">AQBqhxNaKcVpLhAA/</span><span class="hljs-string">P1GVlu3yRugvXkLfgauLA=</span>=</code></pre>
<h2 id="修改用户"><a href="#修改用户" class="headerlink" title="修改用户"></a>修改用户</h2><p>假如用户已经存在, 用过下面方法进行权限修改</p>
<pre><code class="hljs apache"><span class="hljs-attribute">ceph</span> auth caps mgr.openstack mon &#x27;<span class="hljs-literal">allow</span> *&#x27; osd &#x27;<span class="hljs-literal">allow</span> *&#x27; mds &#x27;<span class="hljs-literal">allow</span> *&#x27;
[mgr.openstack]
        <span class="hljs-attribute">key</span> = AQBqhxNaKcVpLhAA/P<span class="hljs-number">1</span>GVlu<span class="hljs-number">3</span>yRugvXkLfgauLA==</code></pre>
<h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><p>提示一下删除用户方法</p>
<pre><code class="hljs css"><span class="hljs-selector-tag">ceph</span> <span class="hljs-selector-tag">auth</span> <span class="hljs-selector-tag">del</span> <span class="hljs-selector-tag">mgr</span><span class="hljs-selector-class">.openstack</span></code></pre>
<h2 id="导出密钥"><a href="#导出密钥" class="headerlink" title="导出密钥"></a>导出密钥</h2><p>需要吧之前创建的用户密码存放至对应位置</p>
<pre><code class="hljs crystal">mkdir /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mgr</span>/<span class="hljs-title">ceph</span>-<span class="hljs-title">openstack</span></span>
ceph auth get mgr.openstack -o /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mgr</span>/<span class="hljs-title">ceph</span>-<span class="hljs-title">openstack</span>/<span class="hljs-title">keyring</span></span>
exported keyring <span class="hljs-keyword">for</span> mgr.openstack</code></pre>
<h2 id="启动-mgr"><a href="#启动-mgr" class="headerlink" title="启动 mgr"></a>启动 mgr</h2><pre><code class="hljs ebnf"><span class="hljs-attribute">ceph-mgr -i openstack</span></code></pre>
<p>然后部署完成之后状态如下：</p>
<h2 id="3-部署ceph-osd"><a href="#3-部署ceph-osd" class="headerlink" title="3.部署ceph-osd"></a>3.部署ceph-osd</h2><p>修改<code>/etc/ceph/ceph.conf</code></p>
<pre><code class="hljs awk">[osd]
run_dir = <span class="hljs-regexp">/data0/</span><span class="hljs-variable">$name</span> 
osd data = <span class="hljs-regexp">/data0/</span><span class="hljs-variable">$name</span>
osd journal = <span class="hljs-regexp">/data0/</span><span class="hljs-variable">$name</span>/journal
osd max object name len = <span class="hljs-number">256</span>
osd max object namespace len = <span class="hljs-number">64</span></code></pre>
<p>笔者这里未专门分配磁盘，<code>/data0/$name</code>写的是<code>/var/lib/ceph/osd/ceph-0</code>，为了确保体验，建议专门为osd和journal分区，最好是xfs系统。</p>
<p>官方给了short-form和long form两种方式，我们选择long form。我们先切换到root权限：</p>
<p>因为下面是脚本模式，$\$var$相当于环境变量。<strong>注意，bash的等号两端不能有空格！</strong></p>
<pre><code class="hljs crystal">sudo bash <span class="hljs-comment"># 运行运行bash脚本</span>
UUID=$(uuidgen) <span class="hljs-comment">#和集群ID一样，OSD也要生成唯一ID </span>
OSD_SECRET=$(ceph-authtool --gen-print-key) <span class="hljs-comment">#生成密匙</span>
sudo cp /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">bootstrap</span>-<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>.<span class="hljs-title">keyring</span> /<span class="hljs-title">etc</span>/<span class="hljs-title">ceph</span>/</span>
ID=$(echo <span class="hljs-string">&quot;&#123;\&quot;cephx_secret\&quot;: \&quot;$OSD_SECRET\&quot;&#125;&quot;</span> | \
   ceph osd new $UUID -i - \
   -n client.bootstrap-osd -k /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">bootstrap</span>-<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>.<span class="hljs-title">keyring</span>) <span class="hljs-comment">#生成OSD-ID，从0开始</span></span>
   
 mkdir /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-$<span class="hljs-title">ID</span></span></code></pre>
<blockquote>
<p>sudo su , sudo su-, sudo bash 均可进入root，区别是 sudo bash更全面，可以运行脚本，开头的命令头是绿字，sudo su- 允许一定场合不用输入密码，而sudo su是进入一般的root模式。</p>
</blockquote>
<div class="note note-warning">
            <p>挂载osd的路径应该与运行操作系统的路径分开。并建议采用xfs文件系统，而不是brtfs或者ext4.</p>
          </div>
<p>我们建议额外分配一定空间专门用作osd存储，以及日志存储，并且将其挂载到<code>/var/lib/ceph/osd/ceph-&#123;osd_num&#125;</code></p>
<pre><code class="hljs crystal">sudo mkfs.xfs /dev/&#123;DEV&#125;
sudo mount /dev/&#123;DEV&#125; /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-$<span class="hljs-title">ID</span></span></code></pre>
<p>如果你像笔者一样粗心，忘了将osd存储和os分开，那么只能进行如下操作</p>
<pre><code class="hljs crystal">sudo mount /dev/sda1 /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-0</span></code></pre>
<pre><code class="hljs crystal">ceph-authtool --create-keyring /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-$<span class="hljs-title">ID</span>/<span class="hljs-title">keyring</span> \</span>
     --name osd.$ID --add-key $OSD_SECRET 
ceph-osd -i $ID --mkfs --osd-uuid $UUID <span class="hljs-comment">#初始化OSD初始目录</span>
chown -R <span class="hljs-symbol">ceph:</span>ceph /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-$<span class="hljs-title">ID</span> <span class="hljs-comment">#目录拥有者，谨慎执行，否则sudo容易挂</span></span></code></pre>
<p>启动osd</p>
<pre><code class="hljs routeros">systemctl <span class="hljs-builtin-name">enable</span> ceph-osd@<span class="hljs-variable">$ID</span>
systemctl start ceph-osd@<span class="hljs-variable">$ID</span></code></pre>
<p>​    检查osd是否启动 ceph -s</p>
<pre><code class="hljs yaml"><span class="hljs-attr">cluster:</span>
  <span class="hljs-attr">id:</span>     <span class="hljs-string">250a1431-6cf3-4d0b-a964-361cd8d10dad</span>
  <span class="hljs-attr">health:</span> <span class="hljs-string">HEALTH_WARN</span>
          <span class="hljs-literal">no</span> <span class="hljs-string">active</span> <span class="hljs-string">mgr</span>
          <span class="hljs-number">1</span> <span class="hljs-string">monitors</span> <span class="hljs-string">have</span> <span class="hljs-string">not</span> <span class="hljs-string">enabled</span> <span class="hljs-string">msgr2</span>
 
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">mon:</span> <span class="hljs-number">1</span> <span class="hljs-string">daemons,</span> <span class="hljs-string">quorum</span> <span class="hljs-string">ceph-master</span> <span class="hljs-string">(age</span> <span class="hljs-string">72m)</span>
  <span class="hljs-attr">mgr:</span> <span class="hljs-literal">no</span> <span class="hljs-string">daemons</span> <span class="hljs-string">active</span>
  <span class="hljs-attr">osd: 1 osds:</span> <span class="hljs-number">0</span> <span class="hljs-string">up,</span> <span class="hljs-number">0</span> <span class="hljs-string">in</span>
 
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">pools:</span>   <span class="hljs-number">0</span> <span class="hljs-string">pools,</span> <span class="hljs-number">0</span> <span class="hljs-string">pgs</span>
  <span class="hljs-attr">objects:</span> <span class="hljs-number">0</span> <span class="hljs-string">objects,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span>
  <span class="hljs-attr">usage:</span>   <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">used,</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">/</span> <span class="hljs-number">0</span> <span class="hljs-string">B</span> <span class="hljs-string">avail</span>
  <span class="hljs-attr">pgs:</span></code></pre>
<p>这就说明我们搭建了一个osd。</p>
<hr>
<h1 id="B-Build-amp-Make-编译源码"><a href="#B-Build-amp-Make-编译源码" class="headerlink" title="B. Build &amp;Make:编译源码"></a>B. <em>Build &amp;Make</em>:编译源码</h1><p><span id="here">您到站了！</span></p>
<p><del>版本14.2.12：Nautilus</del></p>
<p>版本15.2.5：Octopus √ （最新版）</p>
<blockquote>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaochina/p/12275313.html">Nautilus版本部署</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40071358/article/details/106924184">Octopus版本部署</a></p>
</blockquote>
<p>硬件配置</p>
<ul>
<li>Ubuntu18.04 LTS（Bionic Beaver） </li>
</ul>
<p>装完虚拟机，你应该1. <a target="_blank" rel="noopener" href="https://blog.csdn.net/adullperson/article/details/105184861">设置共享文件夹</a> 2. 改变镜像为清华源并update 3. 下载中文输入法vim，chrome等 4. 快照保存 【由于从官网和github下载ceph源码和tarball很慢，我放在我的网盘上】</p>
<blockquote>
<p>如果你，发现硬盘分配小了，想扩容，又不想重新装系统，看<a target="_blank" rel="noopener" href="https://blog.csdn.net/daemon_2017/article/details/80660372">这里</a>。以及磁盘清理<a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37407756/article/details/79903837">技巧</a>。</p>
</blockquote>
<ul>
<li>运存16g+硬盘80g 四核（根据实际情况）</li>
</ul>
<p>（官网要求最少60g空间：A debug build of Ceph may take around 40 gigabytes. If you want to build Ceph in a virtual machine (VM) please make sure total disk space on the VM is at least 60 gigabytes.）</p>
<p>（初始4g+20g出现硬盘不足问题，一怒之下。。）</p>
<p>安装步骤：</p>
<p>下载源码有两种方式：</p>
<ol>
<li>GitHub </li>
</ol>
<pre><code class="hljs awk">git clone --recursive git:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/ceph/</span>ceph <span class="hljs-comment">#recursive是保证下载所有子模块，大小应该有100多M</span></code></pre>
<ol>
<li>tarball</li>
</ol>
<p>【Github下载太慢？baidu网盘】：链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1siz1Bag4Y4XduMLaqc21TQ">https://pan.baidu.com/s/1siz1Bag4Y4XduMLaqc21TQ</a><br>提取码：xahe </p>
<p>如果是虚拟机的话：需要支持共享文件夹。</p>
<pre><code class="hljs dts">tar -<span class="hljs-class">zxvf </span>&#123;文件名&#125; <span class="hljs-meta">#解压</span>
<span class="hljs-class">cd </span>&#123;文件名&#125;</code></pre>
<pre><code class="hljs sql">git submodule <span class="hljs-keyword">update</span> <span class="hljs-comment">--init --recursive #检查有没有模块缺失，试了一下没啥卵用</span>
sudo ./<span class="hljs-keyword">install</span>-deps.sh <span class="hljs-comment">#安装所有依赖，需要大量时间，建议网好的时候进行</span>
sudo ./do_cmake.sh -DCMAKE_BUILD_TYPE=RelWithDebInfo -DWITH_SEASTAR=<span class="hljs-keyword">ON</span> -DWITH_MGR_DASHBOARD_FRONTEND=<span class="hljs-keyword">OFF</span> -DWITH_PYTHON2=<span class="hljs-keyword">OFF</span> -DWITH_PYTHON3=<span class="hljs-keyword">ON</span> -DMGR_PYTHON_VERSION=<span class="hljs-number">3</span> <span class="hljs-comment">#这一步 如果这部报错就试试 sudo ./run-make-check.sh 只要最后build文件夹有makefile就可以了，我们不需要调试信息，需要seastar，不需要前端，采用python3</span>
cd <span class="hljs-keyword">build</span>
sudo make -j4 vstart<span class="hljs-comment"># 保证能运行test cluster就行，这里-j4是线程数，根据实际情况设定</span>
sudo make -j4 <span class="hljs-keyword">all</span> <span class="hljs-comment">#编译所有组件，需要很多空间，根据需要进行</span>
sudo make <span class="hljs-keyword">install</span> <span class="hljs-comment">#别忘了进行安装</span></code></pre>
<p>缺啥补啥 (lib+XX+-dev格式)</p>
<p>比如笔者装了以下库 </p>
<pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> libhwloc-dev
sudo apt <span class="hljs-keyword">install</span> libsctp-dev
sudo apt <span class="hljs-keyword">install</span> libyaml-cpp-dev
sudo apt <span class="hljs-keyword">install</span> ragel</code></pre>
<p>编译可能要5-8小时。建议开个<code>top</code>窗口，看看<code>cc1plus</code>这个进程在不在，如果不在，而且内存没怎么占用，说明程序死了。<code>ctrl+c</code>终止再重新编译。</p>
<hr>
<p>按照官方的测试cluster只用编译到vstart就行了</p>
<p><code>sudo make -j4 vstart</code></p>
<p>如果你遇到问题，请对症下药！</p>
<h2 id="P1-未与github远程库建立联系"><a href="#P1-未与github远程库建立联系" class="headerlink" title="P1:未与github远程库建立联系"></a>P1:未与github远程库建立联系</h2><pre><code class="hljs gradle">CMake Error at src<span class="hljs-regexp">/CMakeFiles/gi</span>t-data/grabRef.cmake:<span class="hljs-number">48</span> (<span class="hljs-keyword">file</span>):
  <span class="hljs-keyword">file</span> failed to open <span class="hljs-keyword">for</span> reading (No such <span class="hljs-keyword">file</span> or directory):

    <span class="hljs-regexp">/home/</span>ceph<span class="hljs-regexp">/Sharing Hub/</span>ceph-master<span class="hljs-regexp">/src/</span>CMakeFiles<span class="hljs-regexp">/git-data/</span>head-ref
<span class="hljs-keyword">Call</span> Stack (most recent <span class="hljs-keyword">call</span> first):
  cmake<span class="hljs-regexp">/modules/G</span>etGitRevisionDescription.cmake:<span class="hljs-number">75</span> (<span class="hljs-keyword">include</span>)
  src/CMakeLists.txt:<span class="hljs-number">216</span> (get_git_head_revision)


CMake Error at src<span class="hljs-regexp">/CMakeFiles/gi</span>t-data/grabRef.cmake:<span class="hljs-number">48</span> (<span class="hljs-keyword">file</span>):
  <span class="hljs-keyword">file</span> failed to open <span class="hljs-keyword">for</span> reading (No such <span class="hljs-keyword">file</span> or directory):

    <span class="hljs-regexp">/home/</span>ceph<span class="hljs-regexp">/Sharing Hub/</span>ceph-master<span class="hljs-regexp">/src/</span>CMakeFiles<span class="hljs-regexp">/git-data/</span>head-ref
<span class="hljs-keyword">Call</span> Stack (most recent <span class="hljs-keyword">call</span> first):
  cmake<span class="hljs-regexp">/modules/G</span>etGitRevisionDescription.cmake:<span class="hljs-number">75</span> (<span class="hljs-keyword">include</span>)
  cmake<span class="hljs-regexp">/modules/G</span>etGitRevisionDescription.cmake:<span class="hljs-number">85</span> (get_git_head_revision)
  src/CMakeLists.txt:<span class="hljs-number">217</span> (git_describe)


CMake Error at src/CMakeLists.txt:<span class="hljs-number">221</span> (<span class="hljs-keyword">if</span>):
  <span class="hljs-keyword">if</span> given arguments:

    <span class="hljs-string">&quot;STREQUAL&quot;</span> <span class="hljs-string">&quot;GITDIR-NOTFOUND&quot;</span>

  Unknown arguments specified


-- Configuring incomplete, errors occurred!
See also <span class="hljs-string">&quot;/home/ceph/Sharing Hub/ceph-master/CMakeFiles/CMakeOutput.log&quot;</span>.
See also <span class="hljs-string">&quot;/home/ceph/Sharing Hub/ceph-master/CMakeFiles/CMakeError.log&quot;</span>.
</code></pre>
<p>注意：千万不要运行<code>make_deb.sh</code>否则所有文件都会被删除</p>
<p>原因：未与远程库建立联系：</p>
<p>解决：在主目录下依次执行</p>
<pre><code class="hljs awk">git init
git remote add origin https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/ceph/</span>ceph.git
git add .
git commit -m <span class="hljs-string">&quot;123&quot;</span></code></pre>
<h2 id="P2：-Python和Ceph使用了不同的OpenSSL库"><a href="#P2：-Python和Ceph使用了不同的OpenSSL库" class="headerlink" title="P2： Python和Ceph使用了不同的OpenSSL库"></a>P2： Python和Ceph使用了不同的OpenSSL库</h2><pre><code class="hljs apache"><span class="hljs-attribute">CMake</span> Error at src/pybind/CMakeLists.txt:<span class="hljs-number">67</span> (message):
  <span class="hljs-attribute">Python</span> and Ceph link to different OpenSSL versions: <span class="hljs-number">1</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1</span>

   <span class="hljs-attribute">vs</span> <span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">2</span>n
</code></pre>
<p>字面意思。Python和Ceph使用了不同的OpenSSL库。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://github.com/ceph/ceph/pull/22659，https://tracker.ceph.com/issues/36425">https://github.com/ceph/ceph/pull/22659，https://tracker.ceph.com/issues/36425</a></p>
<p>问题：默认pyth2链接到openssl1.0.2n(早期版本)</p>
<p>现在的ceph是通过python3编译。python3直接连接到openssl1.1.1，所以我们通过以下参数强制用python3编译。</p>
<pre><code class="hljs routeros"><span class="hljs-attribute">-DWITH_PYTHON2</span>=OFF <span class="hljs-attribute">-DWITH_PYTHON3</span>=ON <span class="hljs-attribute">-DMGR_PYTHON_VERSION</span>=3</code></pre>
<p>只要开始编译就可以停下来了，因为这是单线程很慢，但是基本的makefile已经有了。</p>
<p><code>sudo make -j4</code></p>
<p>这里<code>-j4</code>表示使用4线程编译，会比单线程快很多。</p>
<p>技巧：build过程随时查看Makefile，检查编译进度。如果某个target有问题，我们只需要单独build这个target即可，比如</p>
<pre><code class="hljs puppet">sudo make -<span class="hljs-keyword">j4</span> &#123;挂掉的<span class="hljs-literal">target</span>，在makefile最后可以找到&#125;</code></pre>
<h2 id="p3-内存不足"><a href="#p3-内存不足" class="headerlink" title="p3:内存不足"></a>p3:内存不足</h2><pre><code class="hljs shell">c++: fatal error: Killed signal terminated program cc1plus</code></pre>
<p>这是因为内存不够了。这里有个方法：</p>
<pre><code class="hljs jboss-cli">sudo sh -c &#x27;<span class="hljs-keyword">echo</span> 1 &gt; <span class="hljs-string">/proc/sys/vm/drop_caches</span>&#x27;
sudo sh -c &#x27;<span class="hljs-keyword">echo</span> 2 &gt; <span class="hljs-string">/proc/sys/vm/drop_caches</span>&#x27;
sudo sh -c &#x27;<span class="hljs-keyword">echo</span> 3 &gt; <span class="hljs-string">/proc/sys/vm/drop_caches</span>&#x27;</code></pre>
<p>利用上述命令清理缓存区的内存。</p>
<h2 id="p4-npm问题，不build-MGR-DASHBOARD-FRONTEND就没有问题"><a href="#p4-npm问题，不build-MGR-DASHBOARD-FRONTEND就没有问题" class="headerlink" title="p4:npm问题，不build MGR_DASHBOARD_FRONTEND就没有问题"></a>p4:npm问题，不build MGR_DASHBOARD_FRONTEND就没有问题</h2><pre><code class="hljs gams">Environment <span class="hljs-keyword">variables</span> have <span class="hljs-comment">been set</span>
sh: 1: ng: not <span class="hljs-comment">found</span>
npm <span class="hljs-comment">ERR! file sh</span>
npm <span class="hljs-comment">ERR! code ELIFECYCLE</span>
npm <span class="hljs-comment">ERR! errno ENOENT</span>
npm <span class="hljs-comment">ERR! syscall spawn</span>
npm <span class="hljs-comment">ERR! ceph-dashboard@0.0.0 build:</span> `<span class="hljs-comment">npm run env_build &amp;&amp; ng build</span> <span class="hljs-comment">&quot;--progress=false&quot;</span>`
npm <span class="hljs-comment">ERR! spawn ENOENT</span>
npm <span class="hljs-comment">ERR!</span> 
npm <span class="hljs-comment">ERR! Failed at the ceph-dashboard@0.0.0 build script.</span>
npm <span class="hljs-comment">ERR! This is probably not a problem with npm. There is likely additional logging output above.</span>

npm <span class="hljs-comment">ERR! A complete log of this run can be found in:</span>
npm <span class="hljs-comment">ERR!</span>     /home/<span class="hljs-comment">ceph</span>/.npm/<span class="hljs-comment">_logs</span>/<span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-24</span>T05_33_57_314Z-debug.<span class="hljs-built_in">log</span>
src/<span class="hljs-comment">pybind</span>/mgr/<span class="hljs-comment">dashboard</span>/CMakeFiles/<span class="hljs-comment">mgr-dashboard-frontend-build.dir</span>/build.make:<span class="hljs-number">3072</span>: recipe <span class="hljs-keyword">for</span> target <span class="hljs-comment">&#x27;../src/pybind/mgr/dashboard/frontend/dist&#x27;</span> failed
make[<span class="hljs-number">2</span>]: *** [../<span class="hljs-comment">src</span>/pybind/<span class="hljs-comment">mgr</span>/dashboard/<span class="hljs-comment">frontend</span>/dist] Error <span class="hljs-number">1</span>
CMakeFiles/<span class="hljs-comment">Makefile2:4897: recipe for target</span> <span class="hljs-comment">&#x27;src/pybind/mgr/dashboard/CMakeFiles/mgr-dashboard-frontend-build.dir/all&#x27;</span><span class="hljs-comment"> failed</span>
make[1]: *** [src/pybind/mgr/dashboard/CMakeFiles/mgr-dashboard-frontend-build.dir/all] Error <span class="hljs-comment">2</span>
make[1]: *** Waiting <span class="hljs-comment">for unfinished jobs....</span></code></pre>
<p><strong>注意：built target xxx表示这个任务已经成功编译完了。</strong> </p>
<p>进行到50%提示没有找到ng这个命令,查了一下，是因为没有下npm包的原因，解决办法，如果遇到找不到依赖情况可以根据提示找缺失依赖，逐级寻找：</p>
<p>In case others come here with this issue as I have, here is how I solved it system-wide on MacOS. Hope this helps.</p>
<p>Verify node is installed:</p>
<pre><code class="hljs crmsh">$ <span class="hljs-keyword">node</span> <span class="hljs-title">-v</span>
v11.<span class="hljs-number">2.0</span></code></pre>
<p>Verify npm is installed:</p>
<pre><code class="hljs angelscript">$ npm -v
<span class="hljs-number">6.4</span><span class="hljs-number">.1</span></code></pre>
<p>Verify your npm global install file path is configured (known as <a target="_blank" rel="noopener" href="https://docs.npmjs.com/files/folders#prefix-configuration">prefix</a>). Mine is under ~/.npm-packages:</p>
<pre><code class="hljs routeros">$ npm<span class="hljs-built_in"> config </span>ls -l | grep prefix
prefix = <span class="hljs-string">&quot;/Users/christiangroleau/.npm-packages&quot;</span></code></pre>
<p>If not, you can place it into your ~/.npmrc file:</p>
<pre><code class="hljs jboss-cli"><span class="hljs-keyword">echo</span> prefix=~<span class="hljs-string">/.npm-packages</span> &gt;&gt; ~<span class="hljs-string">/.npmrc</span></code></pre>
<p>Verify that your prefix path is listed in your system PATH:</p>
<pre><code class="hljs awk">$ echo <span class="hljs-variable">$PATH</span>
<span class="hljs-regexp">/Users/</span>christiangroleau<span class="hljs-regexp">/.npm-packages/</span>bin:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin:/u</span>sr<span class="hljs-regexp">/bin:/</span>bin:<span class="hljs-regexp">/usr/</span>sbin:/sbin</code></pre>
<p>If not, invoke the following:</p>
<pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=<span class="hljs-string">&quot;<span class="hljs-variable">$HOME</span>/.npm-packages/bin:<span class="hljs-variable">$PATH</span>&quot;</span></code></pre>
<p>Finally, you can reinstall angular-cli (in my case I needed to install it globally):</p>
<pre><code class="hljs coffeescript">$ <span class="hljs-built_in">npm</span> install -g @angular/cli</code></pre>
<p>Verify installation:</p>
<pre><code class="hljs brainfuck"><span class="hljs-comment">$</span> <span class="hljs-comment">ng</span> <span class="hljs-literal">-</span><span class="hljs-comment">v</span>
<span class="hljs-comment">Mg</span>++ <span class="hljs-comment">version:</span>
<span class="hljs-comment">	Mg</span>++ <span class="hljs-comment">1</span><span class="hljs-string">.</span><span class="hljs-comment">5beta1</span> <span class="hljs-comment">(formerly</span> <span class="hljs-comment">MicroGnuEmacs</span> <span class="hljs-comment">Adv</span><span class="hljs-string">.</span><span class="hljs-comment">)</span></code></pre>
<h2 id="p5-npm被锁"><a href="#p5-npm被锁" class="headerlink" title="p5: npm被锁"></a>p5: npm被锁</h2><pre><code class="hljs gams">Environment <span class="hljs-keyword">variables</span> have <span class="hljs-comment">been set</span>
panic: aborting <span class="hljs-comment">due to terminal initialize failure</span>
Aborted <span class="hljs-comment">(core dumped)</span>
npm <span class="hljs-comment">ERR! code ELIFECYCLE</span>
npm <span class="hljs-comment">ERR! errno 134</span>
npm <span class="hljs-comment">ERR! ceph-dashboard@0.0.0 build:</span> `<span class="hljs-comment">npm run env_build &amp;&amp; ng build</span> <span class="hljs-comment">&quot;--progress=false&quot;</span>`
npm <span class="hljs-comment">ERR! Exit status 134</span>
npm <span class="hljs-comment">ERR!</span> 
npm <span class="hljs-comment">ERR! Failed at the ceph-dashboard@0.0.0 build script.</span>
npm <span class="hljs-comment">ERR! This is probably not a problem with npm. There is likely additional logging output above.</span>

npm <span class="hljs-comment">ERR! A complete log of this run can be found in:</span>
npm <span class="hljs-comment">ERR!</span>     /home/<span class="hljs-comment">ceph</span>/.npm/<span class="hljs-comment">_logs</span>/<span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-24</span>T12_17_18_469Z-debug.<span class="hljs-built_in">log</span>
src/<span class="hljs-comment">pybind</span>/mgr/<span class="hljs-comment">dashboard</span>/CMakeFiles/<span class="hljs-comment">mgr-dashboard-frontend-build.dir</span>/build.make:<span class="hljs-number">3072</span>: recipe <span class="hljs-keyword">for</span> target <span class="hljs-comment">&#x27;../src/pybind/mgr/dashboard/frontend/dist&#x27;</span> failed
make[<span class="hljs-number">2</span>]: *** [../<span class="hljs-comment">src</span>/pybind/<span class="hljs-comment">mgr</span>/dashboard/<span class="hljs-comment">frontend</span>/dist] Error <span class="hljs-number">134</span>
CMakeFiles/<span class="hljs-comment">Makefile2:4897: recipe for target</span> <span class="hljs-comment">&#x27;src/pybind/mgr/dashboard/CMakeFiles/mgr-dashboard-frontend-build.dir/all&#x27;</span><span class="hljs-comment"> failed</span>
make[1]: *** [src/pybind/mgr/dashboard/CMakeFiles/mgr-dashboard-frontend-build.dir/all] Error <span class="hljs-comment">2</span>
make[1]: *** Waiting <span class="hljs-comment">for unfinished jobs....</span>
[ 40%] Built <span class="hljs-comment">target os</span>
[ 46%] Built <span class="hljs-comment">target rbd_internal</span>
[ 51%] Built <span class="hljs-comment">target rgw_common</span>
Makefile:140: recipe <span class="hljs-comment">for target</span> <span class="hljs-comment">&#x27;all&#x27;</span><span class="hljs-comment"> failed</span>
make: *** [all] Error <span class="hljs-comment">2</span>
</code></pre>
<p>这个问题很恶心，花了我很久时间。</p>
<p>首先下载npm</p>
<p> <code>$sudo apt install npm</code></p>
<p>然后，找到<code>/ceph-14.2.4/build/src/pybind/mgr/dashboard/node-env/lib</code>下的<code>node-modules</code></p>
<ul>
<li><code>sudo npm cache clean --force</code></li>
<li>delete <code>node_modules</code> folder, use <code>rm -r</code></li>
<li>delete <code>package-lock.json</code> file </li>
<li><code>sudo npm install</code></li>
</ul>
<p><strong>注意注意注意！</strong>，慎用<code>rm -rf</code>，后果自负！</p>
<h2 id="p6-git文件没版本号"><a href="#p6-git文件没版本号" class="headerlink" title="p6: git文件没版本号"></a>p6: git文件没版本号</h2><pre><code class="hljs angelscript">/home/ceph/ceph<span class="hljs-number">-15.2</span><span class="hljs-number">.5</span>/build/src/include/ceph_ver.h:<span class="hljs-number">4</span>:<span class="hljs-number">26</span>: error: expected ‘=’, ‘,’, ‘;’, ‘asm’ <span class="hljs-keyword">or</span> ‘__attribute__’ before ‘/’ token
    <span class="hljs-number">4</span> | #define CEPH_GIT_VER <span class="hljs-built_in">ref</span>s/heads/master
      |                          ^
/home/ceph/ceph<span class="hljs-number">-15.2</span><span class="hljs-number">.5</span>/src/ceph_ver.c:<span class="hljs-number">6</span>:<span class="hljs-number">34</span>: note: <span class="hljs-keyword">in</span> expansion of macro ‘CONCAT_VER_SYMBOL’
    <span class="hljs-number">6</span> | #define DEFINE_VER_SYMBOL(x) <span class="hljs-built_in">int</span> CONCAT_VER_SYMBOL(x)
      |                                  ^~~~~~~~~~~~~~~~~
/home/ceph/ceph<span class="hljs-number">-15.2</span><span class="hljs-number">.5</span>/src/ceph_ver.c:<span class="hljs-number">8</span>:<span class="hljs-number">1</span>: note: <span class="hljs-keyword">in</span> expansion of macro ‘DEFINE_VER_SYMBOL’
    <span class="hljs-number">8</span> | DEFINE_VER_SYMBOL(CEPH_GIT_VER);
      | ^~~~~~~~~~~~~~~~~
/home/ceph/ceph<span class="hljs-number">-15.2</span><span class="hljs-number">.5</span>/src/ceph_ver.c:<span class="hljs-number">8</span>:<span class="hljs-number">19</span>: note: <span class="hljs-keyword">in</span> expansion of macro ‘CEPH_GIT_VER’
    <span class="hljs-number">8</span> | DEFINE_VER_SYMBOL(CEPH_GIT_VER);
      |                   ^~~~~~~~~~~~
src/CMakeFiles/common-objs.dir/build.make:<span class="hljs-number">63</span>: recipe <span class="hljs-keyword">for</span> target <span class="hljs-string">&#x27;src/CMakeFiles/common-objs.dir/ceph_ver.c.o&#x27;</span> failed
make[<span class="hljs-number">3</span>]: *** [src/CMakeFiles/common-objs.dir/ceph_ver.c.o] Error <span class="hljs-number">1</span>
CMakeFiles/Makefile2:<span class="hljs-number">727</span>: recipe <span class="hljs-keyword">for</span> target <span class="hljs-string">&#x27;src/CMakeFiles/common-objs.dir/all&#x27;</span> failed
make[<span class="hljs-number">2</span>]: *** [src/CMakeFiles/common-objs.dir/all] Error <span class="hljs-number">2</span>
make[<span class="hljs-number">2</span>]: *** Waiting <span class="hljs-keyword">for</span> unfinished jobs....
</code></pre>
<p>找到/home/ceph/ceph-15.2.5/build/src/include/ceph_ver.h文件</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CEPH_GIT_VER refs/heads/master</span></code></pre>
<p>改为</p>
<pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> CEPH_GIT_VER 150205</span></code></pre>
<p>这是不得已之举，必须改成整数版本号，可以解决就将就一下。</p>
<h2 id="p7-undefined-reference-to-HMAC-CTX-new’"><a href="#p7-undefined-reference-to-HMAC-CTX-new’" class="headerlink" title="p7: undefined reference to `HMAC_CTX_new’"></a>p7: undefined reference to `HMAC_CTX_new’</h2><pre><code class="hljs shell">running build
running build_ext
<span class="hljs-meta">[100%</span><span class="bash">] Built target cython_rados</span>
../lib/libcommon.a(Crypto.cc.o): In function `ceph::crypto::ssl::HMAC::HMAC(evp_md_st const*, unsigned char const*, unsigned long)&#x27;:
/home/ceph/ceph-14.2.4/src/common/ceph_crypto.h:284: undefined reference to `HMAC_CTX_new&#x27;
../lib/libcommon.a(Crypto.cc.o): In function `ceph::crypto::ssl::HMAC::~HMAC()&#x27;:
/home/ceph/ceph-14.2.4/src/common/ceph_crypto.h:291: undefined reference to `HMAC_CTX_free&#x27;
../lib/libcommon.a(ceph_crypto.cc.o): In function `ceph::crypto::ssl::OpenSSLDigest::OpenSSLDigest(evp_md_st const*)&#x27;:
/home/ceph/ceph-14.2.4/src/common/ceph_crypto.cc:94: undefined reference to `EVP_MD_CTX_new&#x27;
../lib/libcommon.a(ceph_crypto.cc.o): In function `ceph::crypto::ssl::OpenSSLDigest::~OpenSSLDigest()&#x27;:
/home/ceph/ceph-14.2.4/src/common/ceph_crypto.cc:100: undefined reference to `EVP_MD_CTX_free&#x27;
collect2: error: ld returned 1 exit status
src/CMakeFiles/ceph-osd.dir/build.make:145: recipe for target &#x27;bin/ceph-osd&#x27; failed
make[3]: *** [bin/ceph-osd] Error 1
CMakeFiles/Makefile2:1256: recipe for target &#x27;src/CMakeFiles/ceph-osd.dir/all&#x27; failed
make[2]: *** [src/CMakeFiles/ceph-osd.dir/all] Error 2
CMakeFiles/Makefile2:804: recipe for target &#x27;src/CMakeFiles/vstart-base.dir/rule&#x27; failed
make[1]: *** [src/CMakeFiles/vstart-base.dir/rule] Error 2
Makefile:318: recipe for target &#x27;vstart-base&#x27; failed
make: *** [vstart-base] Error 2
</code></pre>
<p>解决方法</p>
<p><code>sudo apt-get install libssl-dev</code></p>
<h2 id="p8-缺失curl库"><a href="#p8-缺失curl库" class="headerlink" title="p8: 缺失curl库"></a>p8: 缺失curl库</h2><pre><code class="hljs shell">/home/ceph/ceph-14.2.4/src/rgw/rgw_http_client_curl.cc:7:10: fatal error: curl/curl.h: No such file or directory
    7 | #include &lt;curl/curl.h&gt;
      |          ^~~~~~~~~~~~~
compilation terminated.
</code></pre>
<pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> apt install libcurl<span class="hljs-number">4</span>-gnutls</code></pre>
<h2 id="p9-缺失yaml库"><a href="#p9-缺失yaml库" class="headerlink" title="p9: 缺失yaml库"></a>p9: 缺失yaml库</h2><pre><code class="hljs angelscript">Best match: PyYAML <span class="hljs-number">5.3</span><span class="hljs-number">.1</span>
Processing PyYAML<span class="hljs-number">-5.3</span><span class="hljs-number">.1</span>.tar.gz
Writing /tmp/easy_install-_fQ46U/PyYAML<span class="hljs-number">-5.3</span><span class="hljs-number">.1</span>/setup.cfg
Running PyYAML<span class="hljs-number">-5.3</span><span class="hljs-number">.1</span>/setup.py -q bdist_egg --dist-dir /tmp/easy_install-_fQ46U/PyYAML<span class="hljs-number">-5.3</span><span class="hljs-number">.1</span>/egg-dist-tmp-ZSDHMj
In file included <span class="hljs-keyword">from</span> ext/_yaml.c:<span class="hljs-number">596</span>:
ext/_yaml.h:<span class="hljs-number">2</span>:<span class="hljs-number">10</span>: fatal error: yaml.h: No such file <span class="hljs-keyword">or</span> directory
    <span class="hljs-number">2</span> | #include &lt;yaml.h&gt;
      |          ^~~~~~~~
</code></pre>
<pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install libyaml-cpp-<span class="hljs-built_in">dev</span></code></pre>
<h2 id="p10-缺失sdt库"><a href="#p10-缺失sdt库" class="headerlink" title="p10. 缺失sdt库"></a>p10. 缺失sdt库</h2><pre><code class="hljs yaml"><span class="hljs-attr">sys/sdt.h:</span> <span class="hljs-literal">No</span> <span class="hljs-string">such</span> <span class="hljs-string">file</span> <span class="hljs-string">or</span> <span class="hljs-string">directory</span>   
<span class="hljs-number">111</span> <span class="hljs-string">|</span> <span class="hljs-comment">#include &lt;sys/sdt.h&gt;</span></code></pre>
<pre><code class="hljs cmake">sudo apt <span class="hljs-keyword">install</span> systemtap-sdt-dev</code></pre>
<h2 id="p11-undefined-reference-to-symbol-‘HMAC-CTX-new-OPENSSL-1-1-0’，用python2编译会出现这个问题"><a href="#p11-undefined-reference-to-symbol-‘HMAC-CTX-new-OPENSSL-1-1-0’，用python2编译会出现这个问题" class="headerlink" title="p11:undefined reference to symbol ‘HMAC_CTX_new@@OPENSSL_1_1_0’，用python2编译会出现这个问题"></a>p11:undefined reference to symbol ‘HMAC_CTX_new@@OPENSSL_1_1_0’，用python2编译会出现这个问题</h2><pre><code class="hljs shell">/usr/bin/ld: warning: libcrypto.so.1.1, needed by /usr/lib/x86_64-linux-gnu/librabbitmq.so, may conflict with libcrypto.so.1.0.0
/usr/bin/ld: ../../lib/librgw_a.a(rgw_common.cc.o): undefined reference to symbol &#x27;HMAC_CTX_new@@OPENSSL_1_1_0&#x27;
//usr/lib/x86_64-linux-gnu/libcrypto.so.1.1: error adding symbols: DSO missing from command line
collect2: error: ld returned 1 exit status
</code></pre>
<p>OPENSSL有两个版本的库，1.1和1.0.0，很显然我系统安装的是<code>1.1.1</code> 导致冲突了，</p>
<blockquote>
<p>Makefile 选项 CFLAGS 、LDFLAGS 、LIBS<br>CFLAGS 表示用于C编译器的选项<br>CXXFLAGS 表示用于C++编译器的选项<br>这两个变量实际上涵盖了编译和汇编的两个步骤</p>
</blockquote>
<p>CFLAGS：指定头文件(.h)的路径，如：CFLAGS=-I/usr/include -I/path/include 。</p>
<p>相同地，安装一个包时会在安装路径下建立一个include文件夹，当安装过程中出现故障时，试着把曾经安装的包的include文件夹增加到该变量中来。</p>
<p>LDFLAGS：gcc 等编译器会用到的一些优化參数，也能够在里面指定库文件的位置。</p>
<p>使用方法：LDFLAGS=-L/usr/lib -L/path/to/your/lib。每安装一个包都差点儿一定的会在安装文件夹里建立一个lib文件夹。假设明明安装了某个包，而安装还有一个包时，它愣是说找不到，能够抒那个包的lib路径增加的LDFALGS中试一下。</p>
<p>LIBS：告诉链接器要链接哪些库文件。如LIBS = -lpthread -liconv</p>
<p>简单地说，LDFLAGS是告诉链接器从哪里寻找库文件，而LIBS是告诉链接器要链接哪些库文件。</p>
<p>有时候LDFLAGS指定-L尽管能让链接器找到库进行链接。可是运行时链接器却找不到这个库。假设要让软件运行时库文件的路径也得到扩展，那么我们须要增加这两个库给”-Wl,R”：</p>
<p>LDFLAGS = -L/var/xxx/lib -L/opt/mysql/lib -Wl,R/var/xxx/lib -Wl,R/opt/mysql/lib<br>假设在运行./configure曾经环境变量设置export LDFLAGS=”-L/var/xxx/lib -L/opt/mysql/lib -Wl,R/var/xxx/lib -Wl,R/opt/mysql/lib” ，注意环境变量设置等号两边不能够有空格，并且要加上引號（shell的使用方法）。那么运行configure以后。Makefile将会设置这个选项。链接时会有这个參数，编译出来的可运行程序的库文件搜索路径就得到扩展了。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fqnb001/p/8778790.html">什么是软链接，硬链接</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37806908/article/details/97686753">linux .so .o .a文件区别</a></p>
<p>​     .o,是目标文件,相当于windows中的.obj文件 </p>
<p>　.so 为共享库,是shared object,用于动态连接的,相当于windows下的dll </p>
<p>　.a为静态库,是好多个.o合在一起,用于静态连接 </p>
<p><code>sudo ll &#123;文件名&#125;</code> 查看所有链接</p>
<p><code>$sudo unlink libcrypto.so</code>解链接, so表示</p>
<p><code>$sudo ln -s libcrypto.so.1.1 libcrypto.so</code> 添加链接</p>
<p>如何查看openssl版本?</p>
<p><code>openssl version -a</code></p>
<p>ubuntu默认安装1.1.1，没事别卸载，否则很多功能会失效，比如chrome</p>
<h2 id="p12-Make-all-出现ELF-section-name-out-of-range"><a href="#p12-Make-all-出现ELF-section-name-out-of-range" class="headerlink" title="p12. Make all 出现ELF section name out of range"></a>p12. Make all 出现ELF section name out of range</h2><pre><code class="hljs stata">/usr/bin/ld: warning: CMakeFiles/unittest_rbd_mirror.<span class="hljs-keyword">dir</span>/test_mock_ImageReplayer.<span class="hljs-keyword">cc</span>.o has a corrupt string <span class="hljs-keyword">table</span> index - ignoring
/usr/bin/ld: <span class="hljs-keyword">error</span>: CMakeFiles/unittest_rbd_mirror.<span class="hljs-keyword">dir</span>/test_mock_ImageReplayer.<span class="hljs-keyword">cc</span>.o: ELF section name <span class="hljs-keyword">out</span> of <span class="hljs-keyword">range</span>
collect2: <span class="hljs-keyword">error</span>: ld returned 1 <span class="hljs-keyword">exit</span> status
src/<span class="hljs-keyword">test</span>/rbd_mirror/CMakeFiles/unittest_rbd_mirror.<span class="hljs-keyword">dir</span>/build.make:951: recipe <span class="hljs-keyword">for</span> target &#x27;bin/unittest_rbd_mirror&#x27; failed
make[2]: *** [bin/unittest_rbd_mirror] <span class="hljs-keyword">Error</span> 1
CMakeFiles/Makefile2:26032: recipe <span class="hljs-keyword">for</span> target &#x27;src/<span class="hljs-keyword">test</span>/rbd_mirror/CMakeFiles/unittest_rbd_mirror.<span class="hljs-keyword">dir</span>/all&#x27; failed
make[1]: *** [src/<span class="hljs-keyword">test</span>/rbd_mirror/CMakeFiles/unittest_rbd_mirror.<span class="hljs-keyword">dir</span>/all] <span class="hljs-keyword">Error</span> 2
</code></pre>
<p>直接重新make就好了，玄学问题</p>
<h2 id="P13-internal-compiler-error-Segmentation-fault"><a href="#P13-internal-compiler-error-Segmentation-fault" class="headerlink" title="P13:internal compiler error: Segmentation fault"></a>P13:internal compiler error: Segmentation fault</h2><pre><code class="hljs gradle"><span class="hljs-regexp">/home/</span>ceph-server<span class="hljs-regexp">/ceph-15.2.5/</span>src<span class="hljs-regexp">/osd/</span>ECBackend.cc: In member function ‘<span class="hljs-keyword">void</span> ECBackend::filter_read_op(const OSDMapRef&amp;, ECBackend::ReadOp&amp;)’:
<span class="hljs-regexp">/home/</span>ceph-server<span class="hljs-regexp">/ceph-15.2.5/</span>src<span class="hljs-regexp">/osd/</span>ECBackend.cc:<span class="hljs-number">1398</span>:<span class="hljs-number">1</span>: internal compiler error: Segmentation fault
 <span class="hljs-number">1398</span> | &#125;
      | ^
Please submit a full bug report,
with preprocessed <span class="hljs-keyword">source</span> <span class="hljs-keyword">if</span> appropriate.
</code></pre>
<p>重新编译</p>
<hr>
<h1 id="C-Way-to-development…"><a href="#C-Way-to-development…" class="headerlink" title="C. Way to development…"></a>C. <em>Way to development…</em></h1><p>好的在这里假设你编译源码成功了！</p>
<p>先不要庆祝</p>
<p>好戏才刚刚开始！</p>
<h2 id="测试集群"><a href="#测试集群" class="headerlink" title="测试集群"></a>测试集群</h2><pre><code class="hljs shell">../src/vstart.sh --debug --new -x --localhost --bluestore # 启动本地集群 采用bluestore对象存储
./bin/ceph -s #返回集群状态</code></pre>
<p>注：./bin文件，前面只有一个点，你所有能运行的脚本都在这，大部分都无法直接修改！</p>
<p>笔者运行没有遇到问题，有一些问题可以在<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40071358/article/details/106924184">这儿</a>找到答案。</p>
<p>如果没有问题，笔者得到的输出应该如下，你的也应该类似：</p>
<pre><code class="hljs angelscript">*** DEVELOPER MODE: setting PATH, PYTHONPATH <span class="hljs-keyword">and</span> LD_LIBRARY_PATH ***
<span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-31</span>T09:<span class="hljs-number">50</span>:<span class="hljs-number">54.832</span>+<span class="hljs-number">0800</span> <span class="hljs-number">7f</span>1160a3b700 <span class="hljs-number">-1</span> WARNING: all dangerous <span class="hljs-keyword">and</span> experimental features are enabled.
<span class="hljs-number">2020</span><span class="hljs-number">-10</span><span class="hljs-number">-31</span>T09:<span class="hljs-number">50</span>:<span class="hljs-number">54.844</span>+<span class="hljs-number">0800</span> <span class="hljs-number">7f</span>1160a3b700 <span class="hljs-number">-1</span> WARNING: all dangerous <span class="hljs-keyword">and</span> experimental features are enabled.
  cluster:
    id:     <span class="hljs-number">773</span>a0719<span class="hljs-number">-3</span>ed0<span class="hljs-number">-49f</span>a-a168<span class="hljs-number">-88</span>bd2ddc2d00
    health: HEALTH_OK
 
  services:
    mon: <span class="hljs-number">3</span> daemons, quorum a,b,c (age <span class="hljs-number">99</span>s)
    mgr: x(active, since <span class="hljs-number">91</span>s)
    mds: a:<span class="hljs-number">1</span> &#123;<span class="hljs-number">0</span>=c=up:active&#125; <span class="hljs-number">2</span> up:standby
    osd: <span class="hljs-number">3</span> osds: <span class="hljs-number">3</span> up (since <span class="hljs-number">66</span>s), <span class="hljs-number">3</span> <span class="hljs-keyword">in</span> (since <span class="hljs-number">66</span>s)
 
  task status:
    scrub status:
        mds.c: idle
 
  data:
    pools:   <span class="hljs-number">3</span> pools, <span class="hljs-number">65</span> pgs
    objects: <span class="hljs-number">22</span> objects, <span class="hljs-number">2.2</span> KiB
    usage:   <span class="hljs-number">6.0</span> GiB used, <span class="hljs-number">297</span> GiB / <span class="hljs-number">303</span> GiB avail
    pgs:     <span class="hljs-number">65</span> active+clean
</code></pre>
<p><img src="\img\ceph-s.png" srcset="/img/loading.gif" alt="image-20201031225553280"></p>
<p>可以看到mds和osd和mon进程，说明ceph cluster已经运行起来了。</p>
<pre><code class="hljs gradle">.<span class="hljs-regexp">/bin/</span>rados -p rbd bench <span class="hljs-number">30</span> <span class="hljs-keyword">write</span>
.<span class="hljs-regexp">/bin/</span>rbd create foo --<span class="hljs-keyword">size</span> <span class="hljs-number">1000</span></code></pre>
<p>关闭一个cluster用：</p>
<pre><code class="hljs awk">..<span class="hljs-regexp">/src/</span>stop.sh</code></pre>
<p>启动和停止单独的守护进程，<code>sysvinit</code>脚本可以这样用：</p>
<pre><code class="hljs awk">.<span class="hljs-regexp">/bin/i</span>nit-ceph restart osd.<span class="hljs-number">0</span>
.<span class="hljs-regexp">/bin/i</span>nit-ceph stop</code></pre>
<p>如果要build并且进行所有测试</p>
<p>需要全部build，这是极其耗费时间和磁盘的（保守估计要100G以上）。</p>
<pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> make -j<span class="hljs-number">8</span> 
<span class="hljs-attribute">sudo</span> ctest -j<span class="hljs-number">8</span></code></pre>
<p>如果有错误，会在CLI打印出来：</p>
<pre><code class="hljs angelscript"><span class="hljs-number">95</span>% tests passed, <span class="hljs-number">9</span> tests failed <span class="hljs-keyword">out</span> of <span class="hljs-number">192</span>

Total Test time (real) = <span class="hljs-number">579.44</span> sec

The following tests FAILED:
	<span class="hljs-number">111</span> - readable.sh (Failed)
	<span class="hljs-number">177</span> - unittest_rgw_dmclock_scheduler (Failed)
	<span class="hljs-number">184</span> - unittest_rbd_mirror (Not Run)
	<span class="hljs-number">186</span> - unittest_seastar_denc (Not Run)
	<span class="hljs-number">187</span> - unittest_seastar_socket (Not Run)
	<span class="hljs-number">188</span> - unittest_seastar_messenger (Not Run)
	<span class="hljs-number">189</span> - unittest_seastar_thread_pool (Not Run)
	<span class="hljs-number">190</span> - unittest_seastar_perfcounters (Not Run)
	<span class="hljs-number">191</span> - unittest_seastar_lru (Not Run)
Errors <span class="hljs-keyword">while</span> running CTest
</code></pre>
<p>如果想进行单个测试，在/bin文件夹运行对应文件，比如：</p>
<pre><code class="hljs awk">sudo .<span class="hljs-regexp">/bin/u</span>nittest_rbd_mirror</code></pre>
<p>如果没有问题，应该是我这样的：</p>
<pre><code class="hljs angelscript"><span class="hljs-number">99</span>% tests passed, <span class="hljs-number">2</span> tests failed <span class="hljs-keyword">out</span> of <span class="hljs-number">192</span>

Total Test time (real) = <span class="hljs-number">488.16</span> sec

The following tests FAILED:
	<span class="hljs-number">111</span> - readable.sh (Failed)
	<span class="hljs-number">177</span> - unittest_rgw_dmclock_scheduler (Failed)
Errors <span class="hljs-keyword">while</span> running CTest
</code></pre>
<p>上面报错，是因为它们是trivial的，dmclock的api甚至还没开发出来。emoji~</p>
<hr>
<h2 id="调试集群，添加日志"><a href="#调试集群，添加日志" class="headerlink" title="调试集群，添加日志"></a>调试集群，添加日志</h2><p>我们可以在配置文件针对特定模块生成调试日志。但这可能产生超过1GB的日志文件。调试会影响集群的性能。</p>
<p>所以必须保证你磁盘有足够的空间。</p>
<h3 id="实时显示"><a href="#实时显示" class="headerlink" title="实时显示"></a>实时显示</h3><p>如果你希望看到实时调试信息，你必须登录到一台主机上执行：</p>
<pre><code class="hljs routeros">ceph daemon &#123;daemon-name&#125;<span class="hljs-built_in"> config </span>show | less</code></pre>
<p>例如</p>
<pre><code class="hljs routeros">ceph daemon osd.0<span class="hljs-built_in"> config </span>show | less</code></pre>
<p>为了激活调试输出，使用<code>ceph tell</code>:</p>
<pre><code class="hljs routeros">ceph tell &#123;daemon-type&#125;.&#123;daemon id <span class="hljs-keyword">or</span> *&#125;<span class="hljs-built_in"> config </span><span class="hljs-builtin-name">set</span> &#123;name&#125; &#123;value&#125;</code></pre>
<p>daemon-type为mds,mon,osd之一。该命令通过监视器。如果您无法绑定到监视器，则仍然可以通过使用来登录要更改其配置的守护程序的主机，以进行更改。</p>
<p>例如</p>
<pre><code class="hljs routeros">ceph tell osd.0<span class="hljs-built_in"> config </span><span class="hljs-builtin-name">set</span> debug_osd 0/5</code></pre>
<h3 id="启动时调试"><a href="#启动时调试" class="headerlink" title="启动时调试"></a>启动时调试</h3><p>可以在global设置设定</p>
<pre><code class="hljs routeros">[global]
        <span class="hljs-builtin-name">debug</span> ms = 1/5

[mon]
        <span class="hljs-builtin-name">debug</span> mon = 20
        <span class="hljs-builtin-name">debug</span> paxos = 1/5
        <span class="hljs-builtin-name">debug</span> auth = 2

[osd]
        <span class="hljs-builtin-name">debug</span> osd = 1/5
        <span class="hljs-builtin-name">debug</span> filestore = 1/5
        <span class="hljs-builtin-name">debug</span> journal = 1
        <span class="hljs-builtin-name">debug</span> monc = 5/20

[mds]
        <span class="hljs-builtin-name">debug</span> mds = 1
        <span class="hljs-builtin-name">debug</span> mds balancer = 1</code></pre>
<h3 id="加速日志选择"><a href="#加速日志选择" class="headerlink" title="加速日志选择"></a>加速日志选择</h3><p>如果您的操作系统磁盘相对较满，则可以通过在处修改Ceph日志轮换文件来加速日志轮换<code>/etc/logrotate.d/ceph</code>。如果日志超过大小设置，请在旋转频率之后添加大小设置以加速日志旋转（通过cronjob）。例如，默认设置如下所示：</p>
<pre><code class="hljs stata"><span class="hljs-keyword">rotate</span> 7
weekly
<span class="hljs-keyword">compress</span>
sharedscripts</code></pre>
<p>通过添加<code>size</code>设置进行修改。</p>
<pre><code class="hljs angelscript">rotate <span class="hljs-number">7</span>
weekly
size <span class="hljs-number">500</span>M
compress
sharedscripts</code></pre>
<p>然后，为您的用户空间启动crontab编辑器。</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">crontab -e</span></code></pre>
<p>最后，添加一个条目以检查<code>etc/logrotate.d/ceph</code>文件。</p>
<pre><code class="hljs basic"><span class="hljs-symbol">30 </span>* * * * /<span class="hljs-keyword">usr</span>/sbin/logrotate /etc/logrotate.d/ceph &gt;/dev/null <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span></code></pre>
<p>前面的示例<code>etc/logrotate.d/ceph</code>每30分钟检查一次文件。</p>
<h3 id="Valgrind"><a href="#Valgrind" class="headerlink" title="Valgrind"></a>Valgrind</h3><p>调试可能还需要您跟踪内存和线程问题。您可以使用Valgrind运行单个守护程序，一种守护程序或整个集群。您仅应在开发或调试Ceph时使用Valgrind。Valgrind在计算上很昂贵，否则会降低您的系统速度。Valgrind消息已记录到<code>stderr</code>。</p>
<h3 id="子系统，日志和调试设置"><a href="#子系统，日志和调试设置" class="headerlink" title="子系统，日志和调试设置"></a>子系统，日志和调试设置</h3><p>每个子系统都有其输出日志和内存中日志的日志记录级别。通过为调试日志记录设置日志文件级别和内存级别，可以为每个子系统设置不同的值。Ceph的日志记录级别以1到20，1最为简洁，20最为冗余。</p>
<p>调试日志记录设置可以为日志级别和内存级别采用单个值，这会将它们设置为相同的值。例如，如果您指定，则Ceph会将其视为日志级别和内存级别。您也可以单独指定它们。<strong>第一个设置是日志级别，第二个设置是内存级别</strong>。您必须使用正斜杠（/）分隔它们。例如，如果要将子系统的调试日志记录级别设置为，将其内存级别设置为，则可以将其指定为。例如：<code>debug ms = 1/5</code></p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">debug</span> &#123;subsystem&#125; = &#123;<span class="hljs-keyword">log</span>-<span class="hljs-keyword">level</span>&#125;/&#123;memory-<span class="hljs-keyword">level</span>&#125;
<span class="hljs-meta">#for example</span>
<span class="hljs-keyword">debug</span> mds balancer = <span class="hljs-number">1</span>/<span class="hljs-number">20</span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Subsystem</th>
<th style="text-align:left">Log Level</th>
<th style="text-align:left">Memory Level</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>default</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>lockdep</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>context</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>crush</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>mds</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mds balancer</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mds locker</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mds log</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mds log expire</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mds migrator</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>buffer</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>timer</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>filer</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>striper</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>objecter</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>rados</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rbd</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rbd mirror</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rbd replay</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>journaler</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>objectcacher</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>client</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>osd</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>optracker</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>objclass</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>filestore</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left"><code>journal</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left"><code>ms</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mon</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>monc</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left"><code>paxos</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>tp</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>auth</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>crypto</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>finisher</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>reserver</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>heartbeatmap</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>perfcounter</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rgw</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rgw sync</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>civetweb</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">10</td>
</tr>
<tr>
<td style="text-align:left"><code>javaclient</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>asok</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>throttle</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td style="text-align:left"><code>refs</code></td>
<td style="text-align:left">0</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td style="text-align:left"><code>compressor</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>bluestore</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>bluefs</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>bdev</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td style="text-align:left"><code>kstore</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>rocksdb</code></td>
<td style="text-align:left">4</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>leveldb</code></td>
<td style="text-align:left">4</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>memdb</code></td>
<td style="text-align:left">4</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>fuse</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mgr</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>mgrc</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>dpdk</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
<tr>
<td style="text-align:left"><code>eventtrace</code></td>
<td style="text-align:left">1</td>
<td style="text-align:left">5</td>
</tr>
</tbody>
</table>
</div>
<div class="table-container">
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Descrip.</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>log file</td>
<td>The location of the logging file for your cluster.</td>
<td>String</td>
<td>/var/log/ceph/\$cluster-\$name.log</td>
</tr>
<tr>
<td>log max new</td>
<td>The maximum number of recent events to include in a log file.</td>
<td>Integer</td>
<td>10000</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<h2 id="操作集群的三种方法"><a href="#操作集群的三种方法" class="headerlink" title="操作集群的三种方法"></a>操作集群的三种方法</h2><h2 id="1-Systemd-（推荐）"><a href="#1-Systemd-（推荐）" class="headerlink" title="1.Systemd.（推荐）"></a>1.Systemd.（推荐）</h2><p>Systemd 是 Linux 系统工具，用来启动<a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2016/02/linux-daemon.html">守护进程</a>，已成为大多数发行版的标准配置。包括启动，检查，列举systemd，以及停止。</p>
<pre><code class="hljs nginx"><span class="hljs-attribute">sudo</span> systemctl start ceph.target       <span class="hljs-comment"># start all daemons</span>

sudo systemctl status ceph-osd@<span class="hljs-number">12</span>      <span class="hljs-comment"># check status of osd.12</span>

sudo systemctl status ceph\<span class="hljs-regexp">*.service</span> ceph\<span class="hljs-regexp">*.target</span> <span class="hljs-comment"># list the Ceph systemd units on a node</span>
sudo systemctl stop ceph\<span class="hljs-regexp">*.service</span> ceph\<span class="hljs-regexp">*.target</span> <span class="hljs-comment">#stop all the daemons</span>
</code></pre>
<p>如果要启动一个节点上所有特定类型的守护进程。执行下面一个即可：</p>
<pre><code class="hljs aspectj">sudo systemctl start ceph-osd.<span class="hljs-keyword">target</span>
sudo systemctl start ceph-mon.<span class="hljs-keyword">target</span>
sudo systemctl start ceph-mds.<span class="hljs-keyword">target</span></code></pre>
<h2 id="2-Upstart"><a href="#2-Upstart" class="headerlink" title="2.Upstart"></a>2.Upstart</h2><h3 id="启动守护进程"><a href="#启动守护进程" class="headerlink" title="启动守护进程"></a>启动守护进程</h3><p>要在Ceph节点上启动特定的守护程序实例，请执行以下操作之一：</p>
<pre><code class="hljs sql">sudo <span class="hljs-keyword">start</span> ceph-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">start</span> ceph-osd <span class="hljs-keyword">id</span>=&#123;<span class="hljs-keyword">id</span>&#125;
sudo <span class="hljs-keyword">start</span> ceph-mon <span class="hljs-keyword">id</span>=&#123;hostname&#125;
sudo <span class="hljs-keyword">start</span> ceph-mds <span class="hljs-keyword">id</span>=&#123;hostname&#125;
sudo <span class="hljs-keyword">start</span> ceph-osd-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">start</span> ceph-mon-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">start</span> ceph-mds-<span class="hljs-keyword">all</span></code></pre>
<h3 id="停止守护程序"><a href="#停止守护程序" class="headerlink" title="停止守护程序"></a>停止守护程序</h3><p>要在Ceph节点上停止特定的守护程序实例，请执行以下操作之一：</p>
<pre><code class="hljs sql">sudo <span class="hljs-keyword">stop</span> ceph-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">stop</span> ceph-osd <span class="hljs-keyword">id</span>=&#123;<span class="hljs-keyword">id</span>&#125;
sudo <span class="hljs-keyword">stop</span> ceph-mon <span class="hljs-keyword">id</span>=&#123;hostname&#125;
sudo <span class="hljs-keyword">stop</span> ceph-mds <span class="hljs-keyword">id</span>=&#123;hostname&#125;
sudo <span class="hljs-keyword">stop</span> ceph-osd-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">stop</span> ceph-mon-<span class="hljs-keyword">all</span>
sudo <span class="hljs-keyword">stop</span> ceph-mds-<span class="hljs-keyword">all</span></code></pre>
<h2 id="3-Sysvinit"><a href="#3-Sysvinit" class="headerlink" title="3.Sysvinit"></a>3.Sysvinit</h2><p>每次<strong>启动</strong>，<strong>重新启动</strong>和 <strong>停止</strong>Ceph守护程序（或整个集群）时，都必须至少指定一个选项和一个命令。您也可以指定守护程序类型或守护程序实例。</p>
<pre><code class="hljs clojure">&#123;commandline&#125; [options] [commands] [daemons]</code></pre>
<p>该<code>ceph</code>选项包括：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">捷径</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>--verbose</code></td>
<td style="text-align:left"><code>-v</code></td>
<td style="text-align:left">使用详细日志记录。</td>
</tr>
<tr>
<td style="text-align:left"><code>--valgrind</code></td>
<td style="text-align:left"><code>N/A</code></td>
<td style="text-align:left">（仅限Dev和QA）使用<a target="_blank" rel="noopener" href="http://www.valgrind.org/">Valgrind</a>调试。</td>
</tr>
<tr>
<td style="text-align:left"><code>--allhosts</code></td>
<td style="text-align:left"><code>-a</code></td>
<td style="text-align:left">在<code>ceph.conf.</code> 否则的所有节点上执行，否则仅在上执行<code>localhost</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>--restart</code></td>
<td style="text-align:left"><code>N/A</code></td>
<td style="text-align:left">如果核心转储，则自动重新启动守护程序。</td>
</tr>
<tr>
<td style="text-align:left"><code>--norestart</code></td>
<td style="text-align:left"><code>N/A</code></td>
<td style="text-align:left">如果守护程序发生核心转储，请不要重新启动它。</td>
</tr>
<tr>
<td style="text-align:left"><code>--conf</code></td>
<td style="text-align:left"><code>-c</code></td>
<td style="text-align:left">使用备用配置文件。</td>
</tr>
</tbody>
</table>
</div>
<p>这些<code>ceph</code>命令包括：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>start</code></td>
<td style="text-align:left">启动守护程序。</td>
</tr>
<tr>
<td style="text-align:left"><code>stop</code></td>
<td style="text-align:left">停止守护程序。</td>
</tr>
<tr>
<td style="text-align:left"><code>forcestop</code></td>
<td style="text-align:left">强制守护程序停止。与…一样<code>kill -9</code></td>
</tr>
<tr>
<td style="text-align:left"><code>killall</code></td>
<td style="text-align:left">杀死所有特定类型的守护程序。</td>
</tr>
<tr>
<td style="text-align:left"><code>cleanlogs</code></td>
<td style="text-align:left">清除日志目录。</td>
</tr>
<tr>
<td style="text-align:left"><code>cleanalllogs</code></td>
<td style="text-align:left">清除日志目录中的<strong>所有内容</strong>。</td>
</tr>
</tbody>
</table>
</div>
<p>对于子系统操作，<code>ceph</code>服务可以通过为<code>[daemons]</code>选项添加特定的守护程序类型来定位特定的守护程序类型。守护程序类型包括：</p>
<ul>
<li><code>mon</code></li>
<li><code>osd</code></li>
<li><code>mds</code></li>
</ul>
<hr>
<h2 id="了解ceph的健康状况"><a href="#了解ceph的健康状况" class="headerlink" title="了解ceph的健康状况"></a>了解ceph的健康状况</h2><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">状态</th>
<th style="text-align:center">定义</th>
<th>建议</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MON_DOWN</td>
<td style="text-align:center">当前有一个或多个监视守护程序已关闭。该群集需要大多数（超过1/2）的监视器才能正常运行。当一个或多个监视器关闭时，客户端可能很难与群集建立初始连接，因为它们可能需要尝试更多地址才能到达运行中的监视器。</td>
<td>通常，应该尽快重新启动关闭监视器的守护程序，以减少子监视器失败导致服务中断的风险。</td>
</tr>
<tr>
<td style="text-align:center">MON_CLOCK_SKEW</td>
<td style="text-align:center">运行ceph-mon监视器守护程序的主机上的时钟同步不够充分。如果群集检测到时钟偏差大于，则会发出此健康警报<code>mon_clock_drift_allowed</code>。</td>
<td>最好使用诸如<code>ntpd</code>或的工具同步时钟来解决 <code>chrony</code>。</td>
</tr>
<tr>
<td style="text-align:center">MON_MSGR2_NOT_ENABLED</td>
<td style="text-align:center">该<code>ms_bind_msgr2</code>选项已启用，但未将一个或多个监视器配置为绑定到群集monmap中的v2端口。这意味着特定于msgr2协议的功能（例如，加密）在某些或所有连接上不可用。</td>
<td><code>ceph mon enable-msgr2</code>该命令将更改为旧的默认端口6789配置的任何监视器，以继续侦听6789上的v1连接，并继续侦听新的默认3300端口上的v2连接。</td>
</tr>
<tr>
<td style="text-align:center">MON_DISK_LOW \MON_DISK_CRIT</td>
<td style="text-align:center">一台或多台监视器的磁盘空间不足。如果存储监视器数据库的文件系统上的可用空间（通常<code>/var/lib/ceph/mon</code>为百分比）降低至以下百分比<code>mon_data_avail_warn</code>（默认值：30％）， 则将触发此警报。</td>
<td>请通过诸如清理日志文件的方式来增加空间，或者进行扩容。</td>
</tr>
<tr>
<td style="text-align:center">MON_DISK_BIG</td>
<td style="text-align:center">如果监视器数据库的大小大于<code>mon_data_size_warn</code>（默认值：15 GiB），则会触发此警报 。</td>
<td></td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
</div>
<h3 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h3><div class="table-container">
<table>
<thead>
<tr>
<th>状态</th>
<th>定义</th>
<th>建议</th>
</tr>
</thead>
<tbody>
<tr>
<td>MGR_DOWN</td>
<td>当前所有管理器守护程序都已关闭。</td>
<td>应尽快重新启动停机管理器守护程序，以确保可以监视群集。</td>
</tr>
<tr>
<td>MGR_MODULE_DEPENDENCY</td>
<td>已启用的管理器模块未能通过依赖关系检查。此运行状况检查应随附来自模块的有关该问题的解释性消息</td>
<td></td>
</tr>
<tr>
<td>MGR_MODULE_ERROR</td>
<td>管理器模块遇到意外错误。</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<h3 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h3><div class="table-container">
<table>
<thead>
<tr>
<th>状态</th>
<th>定义</th>
<th>解决</th>
</tr>
</thead>
<tbody>
<tr>
<td>OSD_DOWN</td>
<td>标记了一个或多个OSD。ceph-osd守护程序可能已停止，或者对等OSD可能无法通过网络访问OSD。</td>
<td></td>
</tr>
<tr>
<td>OSD_ <CRUSH_TYPE> _DOWN</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OSD_ORPHAN</td>
<td>OSD在CRUSH映射层次结构中被引用，但不存在。</td>
<td>可以使用以下方法从CRUSH层次结构中删除OSD：ceph osd crush rm osd</td>
</tr>
<tr>
<td>OSD_OUT_OF_ORDER_FULL</td>
<td>Nearfull，backfillfull，full和/或failsafe_full的利用率阈值并非升序</td>
<td></td>
</tr>
<tr>
<td>OSD_FULL</td>
<td>一个或多个OSD超出了整个阈值，并正在阻止群集为写入提供服务。</td>
<td></td>
</tr>
<tr>
<td>OSD_BACKFILLFULL</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OSD_NEARFULL</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OSDMAP_FLAGS</td>
<td>已设置一个或多个感兴趣的群集标志。这些标志包括：</td>
<td></td>
</tr>
<tr>
<td>OSD_FLAGS</td>
<td>一个或多个OSD或CRUSH {nodes，device classes}已设置了关注标记</td>
<td></td>
</tr>
<tr>
<td>POOL_FULL</td>
<td>一个或多个池已达到其配额，并且不再允许写入。</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<h3 id="BlueStore"><a href="#BlueStore" class="headerlink" title="BlueStore"></a>BlueStore</h3><div class="table-container">
<table>
<thead>
<tr>
<th>BLUEFS_SPILLOVER</th>
<th>已经为使用BlueStore后端的一个或多个OSD分配了 db分区（用于元数据的存储空间，通常在较快的设备上），但是该空间已满，因此元数据已“溢出”到正常的慢速设备上。</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>BLUEFS_AVAILABLE_SPACE</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BLUEFS_LOW_SPACE</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BLUESTORE_FRAGMENTATION</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BLUESTORE_LEGACY_STATFS</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BLUESTORE_NO_PER_POOL_OMAP</td>
<td>从Octopus版本开始，BlueStore按池跟踪omap空间利用率，并且一个或多个OSD具有在Octopus之前创建的卷。</td>
<td></td>
</tr>
<tr>
<td>BLUESTORE_DISK_SIZE_MISMATCH</td>
<td>使用BlueStore的一个或多个OSD在物理设备的大小和跟踪其大小的元数据之间存在内部不一致。将来可能导致OSD崩溃</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<p>OSDMAP_FLAGS</p>
<ul>
<li><em>full</em>-群集被标记为已满，无法处理写入</li>
<li><em>pauserd</em>，<em>pausewr-</em>暂停的读取或写入</li>
<li><em>noup</em> -OSD不允许启动</li>
<li><em>nodown</em> -OSD故障报告被忽略，因此监视器不会将OSD标记为故障</li>
<li>noin-以前标记屏上显示出来，不会标示后面的，当他们开始</li>
<li><em>noout-</em>在配置的间隔后，不会自动将向下的OSD标记出来</li>
<li><em>nobackfill</em>，<em>norecover</em>，<em>norebalance-</em>恢复或数据重新平衡已暂停</li>
<li><em>noscrub</em>，<em>nodeep_scrub-</em>禁用清理</li>
<li><em>notieragent-</em>缓存分层活动已暂停</li>
</ul>
<p>除<em>full之外</em>，可以使用以下方式设置或清除这些标志：</p>
<pre><code class="hljs pf">ceph osd <span class="hljs-built_in">set</span> <span class="hljs-variable">&lt;flag&gt;</span>
ceph osd unset <span class="hljs-variable">&lt;flag&gt;</span></code></pre>
<p>OSD_FLAGS</p>
<p>一个或多个OSD或CRUSH {nodes，device classes}已设置了关注标记。这些标志包括：</p>
<ul>
<li><em>noup</em>：这些OSD不允许启动</li>
<li><em>nodown</em>：这些OSD的故障报告将被忽略</li>
<li><em>noin</em>：如果以前在故障后自动将这些OSD标记出来，则它们在启动时将不会被标记</li>
<li><em>noout</em>：如果这些OSD处于关闭状态，则在配置的间隔后它们不会自动被标记 出来</li>
</ul>
<p>可以批量设置和清除这些标志：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">osd </span><span class="hljs-built_in">set-group</span> &lt;<span class="hljs-string">flags&gt;</span> &lt;<span class="hljs-string">who&gt;</span>
<span class="hljs-string">ceph </span><span class="hljs-string">osd </span><span class="hljs-string">unset-group </span>&lt;<span class="hljs-string">flags&gt;</span> &lt;<span class="hljs-string">who&gt;</span></code></pre>
<p>可以按以下方式检查池利用率：</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph df</span></code></pre>
<p>当前定义的满比率可以通过以下方式看到：</p>
<pre><code class="hljs gradle">ceph osd <span class="hljs-keyword">dump</span> | <span class="hljs-keyword">grep</span> full_ratio</code></pre>
<p>可以通过以下方式查看池配额和利用率：</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph df detail</span></code></pre>
<p>您可以使用以下方法提高池配额：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">osd </span><span class="hljs-string">pool </span><span class="hljs-built_in">set-quota</span> &lt;<span class="hljs-string">poolname&gt;</span> <span class="hljs-string">max_objects </span>&lt;<span class="hljs-string">num-objects&gt;</span>
<span class="hljs-string">ceph </span><span class="hljs-string">osd </span><span class="hljs-string">pool </span><span class="hljs-built_in">set-quota</span> &lt;<span class="hljs-string">poolname&gt;</span> <span class="hljs-string">max_bytes </span>&lt;<span class="hljs-string">num-bytes&gt;</span></code></pre>
<p>或删除一些现有数据以降低利用率。</p>
<p>要检查BlueFS有多少可用空间，请执行以下操作：</p>
<pre><code class="hljs mipsasm">ceph daemon osd.<span class="hljs-number">123</span> <span class="hljs-keyword">bluestore </span><span class="hljs-keyword">bluefs </span>available</code></pre>
<p>要模拟分配单位不同时的可用空间，请执行以下操作：</p>
<pre><code class="hljs arduino">ceph daemon osd<span class="hljs-number">.123</span> bluestore bluefs <span class="hljs-built_in">available</span> &lt;alloc-unit-<span class="hljs-built_in">size</span>&gt;</code></pre>
<p>要检查BlueStore碎片，可以执行以下操作：</p>
<pre><code class="hljs mipsasm">ceph daemon osd.<span class="hljs-number">123</span> <span class="hljs-keyword">bluestore </span>allocator <span class="hljs-keyword">score </span><span class="hljs-keyword">block</span></code></pre>
<p>如果需要详细的免费碎片报告，请执行以下操作：</p>
<pre><code class="hljs angelscript">ceph daemon osd<span class="hljs-number">.123</span> bluestore allocator dump block</code></pre>
<p>如果处理未运行的OSD进程时可以使用ceph-bluestore-tool检查碎片。获取碎片分数：</p>
<pre><code class="hljs crystal">ceph-bluestore-tool --path /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-123 --<span class="hljs-title">allocator</span> <span class="hljs-title">block</span> <span class="hljs-title">free</span>-<span class="hljs-title">score</span></span></code></pre>
<p>并转储详细的免费块：</p>
<pre><code class="hljs crystal">ceph-bluestore-tool --path /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-123 --<span class="hljs-title">allocator</span> <span class="hljs-title">block</span> <span class="hljs-title">free</span>-<span class="hljs-title">dump</span></span></code></pre>
<p>通过停止每个OSD，运行修复操作并重新启动它，可以将旧的OSD更新为按池跟踪。例如，如果<code>osd.123</code>需要更新，则 ：</p>
<pre><code class="hljs crystal">systemctl stop ceph-osd@<span class="hljs-number">123</span>
ceph-bluestore-tool repair --path /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-123</span>
systemctl start ceph-osd@<span class="hljs-number">123</span></code></pre>
<p>使用BlueStore的一个或多个OSD在物理设备的大小和跟踪其大小的元数据之间存在内部不一致。将来可能导致OSD崩溃。</p>
<p>相关的OSD应该销毁并重新配置。应当小心地一次执行一个OSD，并且这种方式不会使任何数据受到威胁。例如，如果osd<code>$N</code>出现错误，则：</p>
<pre><code class="hljs awk">ceph osd out osd.<span class="hljs-variable">$N</span>
<span class="hljs-keyword">while</span> ! ceph osd safe-to-destroy osd.<span class="hljs-variable">$N</span> ; <span class="hljs-keyword">do</span> sleep <span class="hljs-number">1</span>m ; done
ceph osd destroy osd.<span class="hljs-variable">$N</span>
ceph-volume lvm zap <span class="hljs-regexp">/path/</span>to/device
ceph-volume lvm create --osd-id <span class="hljs-variable">$N</span> --data <span class="hljs-regexp">/path/</span>to/device</code></pre>
<p>可以使用以下方法检查设备的运行状况：</p>
<pre><code class="hljs nginx"><span class="hljs-attribute">ceph</span> device <span class="hljs-literal">info</span> &lt;device-id&gt;</code></pre>
<p>设备预期寿命是由mgr或外部工具通过以下命令运行的预测模型设置的：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">device </span><span class="hljs-built_in">set-life-expectancy</span> &lt;<span class="hljs-string">device-id&gt;</span> &lt;<span class="hljs-string">from&gt;</span> &lt;<span class="hljs-string">to&gt;</span></code></pre>
<p>您可以手动更改存储的预期寿命，但这通常无法完成任何操作，因为最初设置的任何工具都可能会对其进行重新设置，并且更改存储的值不会影响硬件设备的实际运行状况。</p>
<hr>
<h2 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h2><p>所有 Ceph 集群都需要至少一个监视器、且 OSD 数量不小于副本数。自举引导初始监视器是部署 Ceph 存储集群的第一步，监视器的部署也为整个集群奠定了重要框架，如存储池副本数、每个 OSD 拥有的归置组数量（PG）、心跳周期、是否需认证等，其中大多数选项都有默认值，但是建设生产集群时仍需要您熟知它们。</p>
<p><img src="http://docs.ceph.org.cn/_images/ditaa-b67d58275cae03a5573d36907b437e36df685600.png" srcset="/img/loading.gif" alt="img"></p>
<hr>
<h2 id="ceph-monitor配置"><a href="#ceph-monitor配置" class="headerlink" title="ceph monitor配置"></a>ceph monitor配置</h2><ol>
<li>登录到初始监视器节点：</li>
</ol>
<pre><code class="hljs puppet"><span class="hljs-keyword">ssh</span> &#123;<span class="hljs-built_in">hostname</span>&#125;</code></pre>
<p>如：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">ssh</span> node<span class="hljs-number">1</span></code></pre>
<ol>
<li>确保保存 Ceph 配置文件的目录存在， Ceph 默认使用 <code>/etc/ceph</code> 。安装 <code>ceph</code> 软件时，安装器也会自动创建 <code>/etc/ceph/</code> 目录。</li>
</ol>
<pre><code class="hljs awk">ls <span class="hljs-regexp">/etc/</span>ceph</code></pre>
<ol>
<li>创建 Ceph 配置文件， Ceph 默认使用 <code>ceph.conf</code> ，其中的 <code>ceph</code> 是集群名字。</li>
</ol>
<pre><code class="hljs awk">sudo vim <span class="hljs-regexp">/etc/</span>ceph/ceph.conf</code></pre>
<ol>
<li>给集群分配惟一 ID （即 <code>fsid</code> ）。</li>
</ol>
<pre><code class="hljs ebnf"><span class="hljs-attribute">uuidgen</span></code></pre>
<ol>
<li>把此 ID 写入 Ceph 配置文件。</li>
</ol>
<pre><code class="hljs ini"><span class="hljs-attr">fsid</span> = &#123;UUID&#125;</code></pre>
<p>例如：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">fsid</span> = a<span class="hljs-number">7</span>f<span class="hljs-number">64266</span>-<span class="hljs-number">0894</span>-<span class="hljs-number">4</span>f<span class="hljs-number">1</span>e-a<span class="hljs-number">635</span>-d<span class="hljs-number">0</span>aeaca<span class="hljs-number">0</span>e<span class="hljs-number">993</span></code></pre>
<ol>
<li>把初始监视器写入 Ceph 配置文件。</li>
</ol>
<pre><code class="hljs dust"><span class="xml">mon initial members = </span><span class="hljs-template-variable">&#123;hostname&#125;</span><span class="xml">[,</span><span class="hljs-template-variable">&#123;hostname&#125;</span><span class="xml">]</span></code></pre>
<p>例如：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">mon</span> initial members = node<span class="hljs-number">1</span></code></pre>
<ol>
<li>把初始监视器的 IP 地址写入 Ceph 配置文件、并保存。</li>
</ol>
<pre><code class="hljs armasm"><span class="hljs-symbol">mon</span> host = &#123;<span class="hljs-built_in">ip</span>-address&#125;[,&#123;<span class="hljs-built_in">ip</span>-address&#125;]</code></pre>
<p>例如：</p>
<pre><code class="hljs angelscript">mon host = <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span></code></pre>
<p><strong>注意：</strong> 你也可以写 IPv6 地址，但是必须设置 <code>ms bind ipv6 = true</code> 。详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/network-config-ref">网络配置参考</a>。</p>
<ol>
<li>为此集群创建密钥环、并生成监视器密钥。</li>
</ol>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph-authtool </span><span class="hljs-built_in">--create-keyring</span> /<span class="hljs-string">tmp/</span><span class="hljs-string">ceph.</span><span class="hljs-string">mon.</span><span class="hljs-string">keyring </span><span class="hljs-built_in">--gen-key</span> -n <span class="hljs-string">mon.</span> <span class="hljs-built_in">--cap</span> <span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow *&#x27;</span></code></pre>
<ol>
<li>生成管理员密钥环，生成 <code>client.admin</code> 用户并加入密钥环。</li>
</ol>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph-authtool </span><span class="hljs-built_in">--create-keyring</span> /<span class="hljs-string">etc/</span><span class="hljs-string">ceph/</span><span class="hljs-string">ceph.</span><span class="hljs-string">client.</span><span class="hljs-string">admin.</span><span class="hljs-string">keyring </span><span class="hljs-built_in">--gen-key</span> -n <span class="hljs-string">client.</span><span class="hljs-string">admin </span><span class="hljs-built_in">--set-uid=0</span> <span class="hljs-built_in">--cap</span> <span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-built_in">--cap</span> <span class="hljs-string">osd </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-built_in">--cap</span> <span class="hljs-string">mds </span><span class="hljs-string">&#x27;allow&#x27;</span></code></pre>
<p>10.把 <code>client.admin</code> 密钥加入 <code>ceph.mon.keyring</code> 。</p>
<pre><code class="hljs gradle">ceph-authtool <span class="hljs-regexp">/tmp/</span>ceph.mon.keyring --<span class="hljs-keyword">import</span>-keyring <span class="hljs-regexp">/etc/</span>ceph/ceph.client.admin.keyring</code></pre>
<ol>
<li><p>用规划好的主机名、对应 IP 地址、和 FSID 生成一个监视器图，并保存为 <code>/tmp/monmap</code> 。</p>
<pre><code class="hljs puppet">monmaptool --create --<span class="hljs-keyword">add</span> &#123;<span class="hljs-built_in">hostname</span>&#125; &#123;<span class="hljs-literal">ip</span>-address&#125; --<span class="hljs-keyword">fsid</span> &#123;<span class="hljs-built_in">uuid</span>&#125; /tmp/monmap</code></pre>
</li>
<li><p>在监视器主机上分别创建数据目录。</p>
</li>
</ol>
<p>详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/mon-config-ref#data">监视器配置参考——数据</a>。</p>
<pre><code class="hljs crystal">sudo mkdir /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mon</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">hostname</span>&#125;</span></code></pre>
<ol>
<li>用监视器图和密钥环组装守护进程所需的初始数据。</li>
</ol>
<pre><code class="hljs jboss-cli">ceph-mon [<span class="hljs-params">--cluster</span> &#123;cluster-name&#125;] <span class="hljs-params">--mkfs</span> -i &#123;hostname&#125; <span class="hljs-params">--monmap</span> <span class="hljs-string">/tmp/monmap</span> <span class="hljs-params">--keyring</span> <span class="hljs-string">/tmp/ceph.mon.keyring</span></code></pre>
<p>例如：</p>
<pre><code class="hljs jboss-cli">ceph-mon <span class="hljs-params">--mkfs</span> -i node1 <span class="hljs-params">--monmap</span> <span class="hljs-string">/tmp/monmap</span> <span class="hljs-params">--keyring</span> <span class="hljs-string">/tmp/ceph.mon.keyring</span></code></pre>
<ol>
<li>建一个空文件 <code>done</code> ，表示监视器已创建、可以启动了：</li>
</ol>
<pre><code class="hljs crystal">sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mon</span>/<span class="hljs-title">ceph</span>-<span class="hljs-title">node1</span>/<span class="hljs-title">done</span></span></code></pre>
<p>15.启动监视器。</p>
<p>在 Ubuntu 上用 Upstart ：</p>
<pre><code class="hljs pgsql">sudo <span class="hljs-keyword">start</span> ceph-mon id=node1 [<span class="hljs-keyword">cluster</span>=&#123;<span class="hljs-keyword">cluster</span>-<span class="hljs-type">name</span>&#125;]</code></pre>
<ol>
<li>要使此守护进程开机自启，需要创建两个空文件，像这样：</li>
</ol>
<pre><code class="hljs crystal">sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mon</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">hostname</span>&#125;/<span class="hljs-title">upstart</span></span></code></pre>
<p>例如：</p>
<pre><code class="hljs crystal">sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mon</span>/<span class="hljs-title">ceph</span>-<span class="hljs-title">node1</span>/<span class="hljs-title">upstart</span></span></code></pre>
<ol>
<li>验证下 Ceph 已经创建了默认存储池。</li>
</ol>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph osd lspools</span></code></pre>
<p>你应该会看到这样的输出：</p>
<pre><code class="hljs basic"><span class="hljs-symbol">0 </span><span class="hljs-keyword">data</span>,<span class="hljs-number">1</span> metadata,<span class="hljs-number">2</span> rbd,</code></pre>
<ol>
<li>确认下集群在运行。</li>
</ol>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph -s</span></code></pre>
<p>你应该从输出里看到刚刚启动的监视器在正常运行，并且应该会看到一个健康错误：它表明归置组卡在了 <code>stuck inactive</code> 状态。输出大致如此：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">cluster</span> a<span class="hljs-number">7</span>f<span class="hljs-number">64266</span>-<span class="hljs-number">0894</span>-<span class="hljs-number">4</span>f<span class="hljs-number">1</span>e-a<span class="hljs-number">635</span>-d<span class="hljs-number">0</span>aeaca<span class="hljs-number">0</span>e<span class="hljs-number">993</span>
  <span class="hljs-attribute">health</span> HEALTH_ERR <span class="hljs-number">192</span> pgs stuck inactive; <span class="hljs-number">192</span> pgs stuck unclean; no osds
  <span class="hljs-attribute">monmap</span> e<span class="hljs-number">1</span>: <span class="hljs-number">1</span> mons at &#123;node<span class="hljs-number">1</span>=<span class="hljs-number">192.168.0.1:6789</span>/<span class="hljs-number">0</span>&#125;, election epoch <span class="hljs-number">1</span>, quorum <span class="hljs-number">0</span> node<span class="hljs-number">1</span>
  <span class="hljs-attribute">osdmap</span> e<span class="hljs-number">1</span>: <span class="hljs-number">0</span> osds: <span class="hljs-number">0</span> up, <span class="hljs-number">0</span> in
  <span class="hljs-attribute">pgmap</span> v<span class="hljs-number">2</span>: <span class="hljs-number">192</span> pgs, <span class="hljs-number">3</span> pools, <span class="hljs-number">0</span> bytes data, <span class="hljs-number">0</span> objects
     <span class="hljs-attribute">0</span> kB used, <span class="hljs-number">0</span> kB / <span class="hljs-number">0</span> kB avail
     <span class="hljs-attribute">192</span> creating</code></pre>
<p>更详细的介绍可以参考<a href="#MONITOR">MONITOR</a></p>
<hr>
<h2 id="ceph-OSD配置"><a href="#ceph-OSD配置" class="headerlink" title="ceph OSD配置"></a>ceph OSD配置</h2><p>Ceph 配置文件添加 OSD</p>
<p>你的初始监视器可以正常运行后就可以添加 OSD 了。要想让集群达到 <code>active + clean</code> 状态，必须安装足够多的 OSD 来处理对象副本（如 <code>osd pool default size = 2</code> 需要至少 2 个 OSD ）。在完成监视器自举引导后，集群就有了默认的 CRUSH 图，但现在此图还是空的，里面没有任何 OSD 映射到 Ceph 节点。</p>
<h3 id="精简型"><a href="#精简型" class="headerlink" title="精简型"></a>精简型</h3><p>Ceph 软件包提供了 <code>ceph-disk</code> 工具，用于准备硬盘：可以是分区或用于 Ceph 的目录。 <code>ceph-disk</code> 可通过递增索引来创建 OSD ID ；还能把 OSD 加入 CRUSH 图。 <code>ceph-disk</code> 的详细用法可参考 <code>ceph-disk -h</code> ，此工具把后面将提到的<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/install/manual-deployment/#id3">精简型</a>里面的步骤都自动化了。为按照精简型创建前两个 OSD ，在 <code>node2</code> 和 <code>node3</code> 上执行下列命令：</p>
<ol>
<li><p>准备OSD。</p>
<pre><code class="hljs n1ql">ssh &#123;node-name&#125;
sudo ceph-disk <span class="hljs-keyword">prepare</span> --<span class="hljs-keyword">cluster</span> &#123;<span class="hljs-keyword">cluster</span>-name&#125; --<span class="hljs-keyword">cluster</span>-<span class="hljs-built_in">uuid</span> &#123;<span class="hljs-built_in">uuid</span>&#125; --fs-<span class="hljs-built_in">type</span> &#123;ext4|xfs|btrfs&#125; &#123;data-<span class="hljs-keyword">path</span>&#125; [&#123;journal-<span class="hljs-keyword">path</span>&#125;]</code></pre>
<p>例如：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">ssh</span> node<span class="hljs-number">1</span>
<span class="hljs-attribute">sudo</span> ceph-disk prepare --cluster ceph --cluster-uuid a<span class="hljs-number">7</span>f<span class="hljs-number">64266</span>-<span class="hljs-number">0894</span>-<span class="hljs-number">4</span>f<span class="hljs-number">1</span>e-a<span class="hljs-number">635</span>-d<span class="hljs-number">0</span>aeaca<span class="hljs-number">0</span>e<span class="hljs-number">993</span> --fs-type ext<span class="hljs-number">4</span> /dev/hdd<span class="hljs-number">1</span></code></pre>
</li>
<li><p>激活 OSD：</p>
<pre><code class="hljs puppet">sudo ceph-disk <span class="hljs-keyword">activate</span> &#123;data-<span class="hljs-built_in">path</span>&#125; [--activate-<span class="hljs-keyword">key</span> &#123;<span class="hljs-built_in">path</span>&#125;]</code></pre>
<p>例如：</p>
<pre><code class="hljs awk">sudo ceph-disk activate <span class="hljs-regexp">/dev/</span>hdd1</code></pre>
<p><strong>注：</strong> 如果你的 Ceph 节点上没有 <code>/var/lib/ceph/bootstrap-osd/&#123;cluster&#125;.keyring</code> ，那么应该外加 <code>--activate-key</code> 参数。</p>
</li>
</ol>
<h3 id="细致型"><a href="#细致型" class="headerlink" title="细致型"></a>细致型</h3><p>要是不想借助任何辅助工具，可按下列步骤创建 OSD 、将之加入集群和 CRUSH 图。按下列详细步骤可在 <code>node2</code> 和 <code>node3</code> 上增加前 2 个 OSD ：</p>
<ol>
<li><p>登录到OSD主机。</p>
<pre><code class="hljs crmsh">ssh &#123;<span class="hljs-keyword">node</span><span class="hljs-title">-name</span>&#125;</code></pre>
</li>
<li><p>给 OSD 分配 UUID 。</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">uuidgen</span></code></pre>
</li>
<li><p>创建 OSD 。如果没有指定 UUID ，将会在 OSD 首次启动时分配一个。下列命令执行完成后将输出 OSD 号，在后续步骤里还会用到这个号。</p>
<pre><code class="hljs sql">ceph osd <span class="hljs-keyword">create</span> [&#123;<span class="hljs-keyword">uuid</span>&#125; [&#123;<span class="hljs-keyword">id</span>&#125;]]</code></pre>
</li>
<li><p>在新 OSD 主机上创建默认目录。</p>
<pre><code class="hljs crystal">ssh &#123;new-osd-host&#125;
sudo mkdir /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">osd</span>-<span class="hljs-title">number</span>&#125;</span></code></pre>
</li>
<li><p>如果要把 OSD 装到非系统盘的独立硬盘上，先创建文件系统、然后挂载到刚创建的目录下：</p>
<pre><code class="hljs crystal">ssh &#123;new-osd-host&#125;
sudo mkfs -t &#123;fstype&#125; /dev/&#123;hdd&#125;
sudo mount -o user_xattr /dev/&#123;hdd&#125; /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">osd</span>-<span class="hljs-title">number</span>&#125;</span></code></pre>
</li>
<li><p>初始化 OSD 数据目录：</p>
<pre><code class="hljs puppet"><span class="hljs-keyword">ssh</span> &#123;new-osd-host&#125;
<span class="hljs-keyword">sudo</span> <span class="hljs-keyword">ceph</span>-osd -<span class="hljs-keyword">i</span> &#123;osd-num&#125; --mkfs --mkkey --osd-uuid [&#123;uuid&#125;]</code></pre>
<p>加 <code>--mkkey</code> 选项运行 <code>ceph-osd</code> 之前，此目录必须是空的；另外，如果集群名字不是默认值，还要给 <code>ceph-osd</code> 指定 <code>--cluster</code> 选项。</p>
</li>
<li><p>注册此 OSD 的密钥。路径内 <code>ceph-&#123;osd-num&#125;</code> 里的 <code>ceph</code> 其含义为 <code>$cluster-$id</code> ，如果你的集群名字不是 <code>ceph</code> ，请指定自己的集群名：</p>
<pre><code class="hljs crystal">sudo ceph auth add osd.&#123;osd-num&#125; osd <span class="hljs-string">&#x27;allow *&#x27;</span> mon <span class="hljs-string">&#x27;allow profile osd&#x27;</span> -i /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">osd</span>-<span class="hljs-title">num</span>&#125;/<span class="hljs-title">keyring</span></span></code></pre>
</li>
<li><p>把此节点加入 CRUSH 图。</p>
<pre><code class="hljs smali">ceph [--cluster &#123;cluster-name&#125;] osd crush<span class="hljs-built_in"> add-bucket </span>&#123;hostname&#125; host</code></pre>
<p>例如：</p>
<pre><code class="hljs smali">ceph osd crush<span class="hljs-built_in"> add-bucket </span>node1 host</code></pre>
</li>
<li><p>把此 Ceph 节点放入 <code>default</code> 根下。</p>
<pre><code class="hljs arduino">ceph osd crush <span class="hljs-built_in">move</span> node1 root=<span class="hljs-keyword">default</span></code></pre>
</li>
<li><p>把此 OSD 加入 CRUSH 图之后，它就能接收数据了。你也可以反编译 CRUSH 图、把此 OSD 加入设备列表、对应主机作为桶加入（如果它还不在 CRUSH 图里）、然后此设备作为主机的一个条目、分配权重、重新编译、注入集群。</p>
<pre><code class="hljs dust"><span class="xml">ceph [--cluster </span><span class="hljs-template-variable">&#123;cluster-name&#125;</span><span class="xml">] osd crush add </span><span class="hljs-template-variable">&#123;id-or-name&#125;</span><span class="xml"> </span><span class="hljs-template-variable">&#123;weight&#125;</span><span class="xml"> [</span><span class="hljs-template-variable">&#123;bucket-type&#125;</span><span class="xml">=</span><span class="hljs-template-variable">&#123;bucket-name&#125;</span><span class="xml"> ...]</span></code></pre>
<p>例如：</p>
<pre><code class="hljs apache"><span class="hljs-attribute">ceph</span> osd crush add osd.<span class="hljs-number">0</span> <span class="hljs-number">1</span>.<span class="hljs-number">0</span> host=node<span class="hljs-number">1</span></code></pre>
</li>
<li><p>把 OSD 加入 Ceph 后， OSD 已经在配置里了。但它还没开始运行，这时处于 <code>down</code> 且 <code>in</code> 状态，要启动进程才能收数据。</p>
<p>在 Ubuntu 系统上用 Upstart 启动：</p>
<pre><code class="hljs pgsql">sudo <span class="hljs-keyword">start</span> ceph-osd id=&#123;osd-num&#125; [<span class="hljs-keyword">cluster</span>=&#123;<span class="hljs-keyword">cluster</span>-<span class="hljs-type">name</span>&#125;]</code></pre>
<p>例如：</p>
<pre><code class="hljs routeros">sudo start ceph-osd <span class="hljs-attribute">id</span>=0
sudo start ceph-osd <span class="hljs-attribute">id</span>=1</code></pre>
<p>在 Debian/CentOS/RHEL 上用 sysvinit 启动：</p>
<pre><code class="hljs sql">sudo /etc/init.d/ceph <span class="hljs-keyword">start</span> osd.&#123;osd-<span class="hljs-keyword">num</span>&#125; [<span class="hljs-comment">--cluster &#123;cluster-name&#125;]</span></code></pre>
<p>例如：</p>
<pre><code class="hljs awk">sudo <span class="hljs-regexp">/etc/i</span>nit.d/ceph start osd.<span class="hljs-number">0</span>
sudo <span class="hljs-regexp">/etc/i</span>nit.d/ceph start osd.<span class="hljs-number">1</span></code></pre>
<p>要让守护进程开机自启，必须创建一个空文件：</p>
<pre><code class="hljs crystal">sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/&#123;<span class="hljs-title">cluster</span>-<span class="hljs-title">name</span>&#125;-&#123;<span class="hljs-title">osd</span>-<span class="hljs-title">num</span>&#125;/<span class="hljs-title">sysvinit</span></span></code></pre>
<p>例如：</p>
<pre><code class="hljs crystal">sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-0/<span class="hljs-title">sysvinit</span></span>
sudo touch /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">osd</span>/<span class="hljs-title">ceph</span>-1/<span class="hljs-title">sysvinit</span></span></code></pre>
<p>OSD 启动后，它应该处于 <code>up</code> 且 <code>in</code> 状态。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>监视器和两个 OSD 开始正常运行后，你就可以通过下列命令观察归置组互联过程了：</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">ceph -w</span></code></pre>
<p>执行下列命令查看 OSD树：</p>
<pre><code class="hljs dos">ceph osd <span class="hljs-built_in">tree</span></code></pre>
<p>你应该会看到类似如下的输出：</p>
<pre><code class="hljs lsl"># id    weight  type name       up/down reweight
<span class="hljs-number">-1</span>      <span class="hljs-number">2</span>       root <span class="hljs-section">default</span>
<span class="hljs-number">-2</span>      <span class="hljs-number">2</span>               host node1
<span class="hljs-number">0</span>       <span class="hljs-number">1</span>                       osd<span class="hljs-number">.0</span>   up      <span class="hljs-number">1</span>
<span class="hljs-number">-3</span>      <span class="hljs-number">1</span>               host node2
<span class="hljs-number">1</span>       <span class="hljs-number">1</span>                       osd<span class="hljs-number">.1</span>   up      <span class="hljs-number">1</span></code></pre>
<p>要增加（或删除）额外监视器，参见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/add-or-rm-mons">增加/删除监视器</a>。要增加（或删除）额外 OSD ，参见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/add-or-rm-osds">增加/删除 OSD</a> 。可用于配置存储集群内的所有守护进程、或者某一类型的所有守护进程。要配置一系列守护进程，这些配置必须位于能收到配置的段落之下，比如：</p>
<pre><code class="hljs json">[global]</code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>[global]</code> 下的配置影响 Ceph 集群里的所有守护进程。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>auth supported = cephx</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs json">[osd]</code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>[osd]</code> 下的配置影响存储集群里的所有 <code>ceph-osd</code> 进程，并且会覆盖 <code>[global]</code> 下的同一选项。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>osd journal size = 1000</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs json">[mon]</code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>[mon]</code> 下的配置影响集群里的所有 <code>ceph-mon</code> 进程，并且会覆盖 <code>[global]</code> 下的同一选项。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>mon addr = 10.0.0.101:6789</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs json">[mds]</code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>[mds]</code> 下的配置影响集群里的所有 <code>ceph-mds</code> 进程，并且会覆盖 <code>[global]</code> 下的同一选项。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>host = myserver01</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs json">[client]</code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>[client]</code> 下的配置影响所有客户端（如挂载的 Ceph 文件系统、挂载的块设备等等）。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>log file = /var/log/ceph/radosgw.log</code></td>
</tr>
</tbody>
</table>
</div>
<p>全局设置影响集群内所有守护进程的例程，所以 <code>[global]</code> 可用于设置适用所有守护进程的选项。但可以用这些覆盖 <code>[global]</code> 设置：</p>
<ol>
<li>在 <code>[osd]</code> 、 <code>[mon]</code> 、 <code>[mds]</code> 下更改某一类进程的配置。</li>
<li>更改特定进程的设置，如 <code>[osd.1]</code> 。</li>
</ol>
<p>覆盖全局设置会影响所有子进程，明确剔除的例外。</p>
<p>典型的全局设置包括激活认证，例如：</p>
<pre><code class="hljs routeros">[global]
<span class="hljs-comment">#Enable authentication between hosts within the cluster.</span>
<span class="hljs-comment">#v 0.54 and earlier</span>
auth supported = cephx

<span class="hljs-comment">#v 0.55 and after</span>
auth cluster required = cephx
auth<span class="hljs-built_in"> service </span>required = cephx
auth<span class="hljs-built_in"> client </span>required = cephx</code></pre>
<p>你可以统一配置一类守护进程。配置写到 <code>[osd]</code> 、 <code>[mon]</code> 、 <code>[mds]</code> 下时，无须再指定某个特定例程，即可分别影响所有 OSD 、监视器、元数据进程。</p>
<p>典型的类范畴配置包括日志尺寸、 filestore 选项等，如：</p>
<pre><code class="hljs angelscript">[osd]
osd journal size = <span class="hljs-number">1000</span></code></pre>
<p>你也可以配置某个特定例程。一个例程由类型和及其例程 ID 确定， OSD 的例程 ID 只能是数字，但监视器和元数据服务器的 ID 可包含字母和数字。</p>
<pre><code class="hljs ini"><span class="hljs-section">[osd.1]</span>
<span class="hljs-comment"># settings affect osd.1 only.</span>

<span class="hljs-section">[mon.a]</span>
<span class="hljs-comment"># settings affect mon.a only.</span>

<span class="hljs-section">[mds.b]</span>
<span class="hljs-comment"># settings affect mds.b only.</span></code></pre>
<p>如果你想配置某个 Ceph 网关客户端，可以用点（ . ）分隔的守护进程和例程来指定，例如：</p>
<pre><code class="hljs clean">[client.radosgw.<span class="hljs-keyword">instance</span>-name]
# settings affect client.radosgw.<span class="hljs-keyword">instance</span>-name only.</code></pre>
<h2 id="元变量¶"><a href="#元变量¶" class="headerlink" title="元变量¶"></a>元变量<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/ceph-conf/#ceph-metavariables">¶</a></h2><p>元变量大大简化了集群配置。 Ceph 会把配置的元变量展开为具体值；元变量功能很强大，可以用在配置文件的 <code>[global]</code> 、 <code>[osd]</code> 、 <code>[mon]</code> 、 <code>[mds]</code> 段里，类似于 Bash 的 shell 扩展。</p>
<p>Ceph 支持下列元变量：</p>
<pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-meta-keyword">$cluster</span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>展开为存储集群名字，在同一套硬件上运行多个集群时有用。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>/etc/ceph/$cluster.keyring</code></td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>ceph</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs elm">$<span class="hljs-keyword">type</span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>可展开为 <code>mds</code> 、 <code>osd</code> 、 <code>mon</code> 中的一个，有赖于当前守护进程的类型。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>/var/lib/ceph/$type</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-meta-keyword">$id</span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>展开为守护进程标识符； <code>osd.0</code> 应为 <code>0</code> ， <code>mds.a</code> 是 <code>a</code> 。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>/var/lib/ceph/$type/$cluster-$id</code></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-meta-keyword">$host</span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>展开为当前守护进程的主机名。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
</div>
<pre><code class="hljs gams"><span class="hljs-meta"><span class="hljs-meta-keyword">$name</span></span></code></pre>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>展开为 <code>$type.$id</code> 。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">实例:</td>
<td><code>/var/run/ceph/$cluster-$name.asok</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="共有选项"><a href="#共有选项" class="headerlink" title="共有选项"></a>共有选项</h2><p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/install/hardware-recommendations">硬件推荐</a>段提供了一些配置 Ceph 存储集群的硬件指导。一个 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-13"><em>Ceph 节点</em></a>可以运行多个进程，例如一个节点有多个硬盘，可以为每个硬盘配置一个 <code>ceph-osd</code> 守护进程。理想情况下一台主机应该只运行一类进程，例如：一台主机运行着 <code>ceph-osd</code> 进程，另一台主机运行着 <code>ceph-mds</code> 进程， <code>ceph-mon</code> 进程又在另外一台主机上。</p>
<p>各节点都用 <code>host</code> 选项指定主机名字，监视器还需要用 <code>addr</code> 选项指定网络地址和端口（即域名或 IP 地址）。基本配置文件可以只指定最小配置。例如：</p>
<pre><code class="hljs ini"><span class="hljs-section">[global]</span>
<span class="hljs-attr">mon_initial_members</span> = ceph1
<span class="hljs-attr">mon_host</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.1</span></code></pre>
<div class="note note-danger">
            <p><code>host</code> 选项是此节点的短名字，不是全资域名（ FQDN ），也<strong>不是</strong> IP 地址；执行 <code>hostname -s</code> 即可得到短名字。不要给初始监视器之外的例程设置 <code>host</code> ，除非你想手动部署；<strong>一定不能</strong>用于 <code>chef</code> 或 <code>ceph-deploy</code> ，这些工具会自动获取正确结果。</p>
          </div>
<h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p><img src="\img\ceph-network.png" srcset="/img/loading.gif" alt="img"></p>
<ol>
<li><strong>性能：</strong> OSD 为客户端处理数据复制，复制多份时 OSD 间的网络负载势必会影响到客户端和 Ceph 集群的通讯，包括延时增加、产生性能问题；恢复和重均衡也会显著增加公共网延时。关于 Ceph 如何复制参见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/architecture#scalability-and-high-availability">伸缩性和高可用性</a>；关于心跳流量参见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/mon-osd-interaction">监视器与 OSD 的交互</a>。</li>
<li><strong>安全：</strong> 大多数人都是良民，很少的一撮人喜欢折腾拒绝服务攻击（ DoS ）。当 OSD 间的流量失控时，归置组再也不能达到 <code>active + clean</code> 状态，这样用户就不能读写数据了。挫败此类攻击的一种好方法是<u>维护一个完全独立的集群网，使之不能直连互联网</u>；另外，请考虑用<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/auth-config-ref#signatures">消息签名</a>防止欺骗攻击。</li>
</ol>
<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><p>守护进程默认会<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/network-config-ref/#id10">绑定</a>到 <code>6800:7300</code> 间的端口，你可以更改此范围。更改防火墙配置前先检查下 <code>iptables</code> 配置。</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">sudo iptables -L</span></code></pre>
<p>一些 Linux 发行版的规则拒绝除 SSH 之外的所有网卡的所有入栈连接，例如：</p>
<pre><code class="hljs vhdl"><span class="hljs-keyword">REJECT</span> <span class="hljs-keyword">all</span> <span class="hljs-comment">-- anywhere anywhere reject-with icmp-host-prohibited</span></code></pre>
<p>你得先删掉公共网和集群网对应的这些规则，然后再增加安全保护规则。</p>
<h3 id="监视器防火墙"><a href="#监视器防火墙" class="headerlink" title="监视器防火墙"></a>监视器防火墙</h3><p>监视器默认监听 <code>6789</code> 端口，而且监视器总是运行在公共网。按下例增加规则时，要把 <code>&#123;iface&#125;</code> 替换为公共网接口（如 <code>eth0</code> 、 <code>eth1</code> 等等）、 <code>&#123;ip-address&#125;</code> 替换为公共网 IP 、 <code>&#123;netmask&#125;</code> 替换为公共网掩码。</p>
<pre><code class="hljs dust"><span class="xml">sudo iptables -A INPUT -i </span><span class="hljs-template-variable">&#123;iface&#125;</span><span class="xml"> -p tcp -s </span><span class="hljs-template-variable">&#123;ip-address&#125;</span><span class="xml">/</span><span class="hljs-template-variable">&#123;netmask&#125;</span><span class="xml"> --dport 6789 -j ACCEPT</span></code></pre>
<h3 id="MDS-防火墙"><a href="#MDS-防火墙" class="headerlink" title="MDS 防火墙"></a>MDS 防火墙</h3><p><a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/glossary/#term-64"><em>元数据服务器</em></a>会监听公共网 6800 以上的第一个可用端口。需要注意的是，这种行为是不确定的，所以如果你在同一主机上运行多个 OSD 或 MDS 、或者在很短的时间内重启了多个守护进程，它们会绑定更高的端口号；所以说你应该预先打开整个 6800-7300 端口区间。按下例增加规则时，要把 <code>&#123;iface&#125;</code> 替换为公共网接口（如 <code>eth0</code> 、 <code>eth1</code> 等等）、 <code>&#123;ip-address&#125;</code> 替换为公共网 IP 、 <code>&#123;netmask&#125;</code> 替换为公共网掩码。</p>
<p>例如：</p>
<pre><code class="hljs dust"><span class="xml">sudo iptables -A INPUT -i </span><span class="hljs-template-variable">&#123;iface&#125;</span><span class="xml"> -m multiport -p tcp -s </span><span class="hljs-template-variable">&#123;ip-address&#125;</span><span class="xml">/</span><span class="hljs-template-variable">&#123;netmask&#125;</span><span class="xml"> --dports 6800:7300 -j ACCEPT</span></code></pre>
<h3 id="OSD-防火墙"><a href="#OSD-防火墙" class="headerlink" title="OSD 防火墙"></a>OSD 防火墙</h3><p>OSD 守护进程默认<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/network-config-ref/#id10">绑定</a> 从 6800 起的第一个可用端口，需要注意的是，这种行为是不确定的，所以如果你在同一主机上运行多个 OSD 或 MDS 、或者在很短的时间内重启了多个守护进程，它们会绑定更高的端口号。一主机上的各个 OSD 最多会用到 4 个端口：</p>
<ol>
<li>一个用于和客户端、监视器通讯；</li>
<li>一个用于发送数据到其他 OSD ；</li>
<li>两个用于各个网卡上的心跳；</li>
</ol>
<p><img src="\img\ceph-firewall.png" srcset="/img/loading.gif" alt="img"></p>
<p>当某个守护进程失败并重启时没释放端口，重启后的进程就会监听新端口。你应该打开整个 6800-7300 端口区间，以应对这种可能性。</p>
<p>如果你分开了公共网和集群网，必须分别为之设置防火墙，因为客户端会通过公共网连接、而其他 OSD 会通过集群网连接。按下例增加规则时，要把 <code>&#123;iface&#125;</code> 替换为网口（如 <code>eth0</code> 、 <code>eth1</code> 等等）、 <code>&#123;ip-address&#125;</code> 替换为公共网或集群网 IP 、 <code>&#123;netmask&#125;</code> 替换为公共网或集群网掩码。例如：</p>
<pre><code class="hljs dust"><span class="xml">sudo iptables -A INPUT -i </span><span class="hljs-template-variable">&#123;iface&#125;</span><span class="xml">  -m multiport -p tcp -s </span><span class="hljs-template-variable">&#123;ip-address&#125;</span><span class="xml">/</span><span class="hljs-template-variable">&#123;netmask&#125;</span><span class="xml"> --dports 6800:7300 -j ACCEPT</span></code></pre>
<div class="note note-primary">
            <p>如果你的元数据服务器和 OSD 在同一节点上，可以合并公共网配置。</p>
          </div>
<h2 id="CEPH-网络"><a href="#CEPH-网络" class="headerlink" title="CEPH 网络"></a>CEPH 网络</h2><p>Ceph 的网络配置要放到 <code>[global]</code> 段下。前述的 5 分钟快速入门提供了一个简陋的 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/start/quick-ceph-deploy/#create-a-cluster">Ceph 配置文件</a>，它假设服务器和客户端都位于同一网段， Ceph 可以很好地适应这种情形。然而 Ceph 允许配置更精细的公共网，包括多 IP 和多掩码；也能用单独的集群网处理 OSD 心跳、对象复制、和恢复流量。不要混淆你配置的 IP 地址和客户端用来访问存储服务的公共网地址。典型的内网常常是 <code>192.168.0.0</code> 或 <code>10.0.0.0</code> 。</p>
 <div class="note note-primary">
            <p>如果你给公共网或集群网配置了多个 IP 地址及子网掩码，这些子网必须能互通。另外要确保在防火墙上为各 IP 和子网开放了必要的端口。</p><p>Ceph 用 CIDR 法表示子网(IP地址/网络ID的位数)，如 <code>10.0.0.0/24</code> 。</p>
          </div>
<p>配置完几个网络后，可以重启集群或挨个重启守护进程。 Ceph 守护进程动态地绑定端口，所以更改网络配置后无需重启整个集群。</p>
<h3 id="公共网"><a href="#公共网" class="headerlink" title="公共网"></a>公共网</h3><p>要配置一个公共网，把下列选项加到配置文件的 <code>[global]</code> 段下。</p>
<pre><code class="hljs routeros">[global]
        <span class="hljs-built_in">..</span>.
        public<span class="hljs-built_in"> network </span>= &#123;public-network/netmask&#125;</code></pre>
<h3 id="集群网"><a href="#集群网" class="headerlink" title="集群网"></a>集群网</h3><p>如果你声明了集群网， OSD 将把心跳、对象复制和恢复流量路由到集群网，与单个网络相比这会提升性能。要配置集群网，把下列选项加进配置文件的 <code>[global]</code> 段。</p>
<pre><code class="hljs routeros">[global]
        <span class="hljs-built_in">..</span>.
        cluster<span class="hljs-built_in"> network </span>= &#123;cluster-network/netmask&#125;</code></pre>
<p>为安全起见，从公共网或互联网到集群网应该是<strong>不可达</strong>的。</p>
<h2 id="CEPH-守护进程"><a href="#CEPH-守护进程" class="headerlink" title="CEPH 守护进程"></a>CEPH 守护进程</h2><p>有一个网络配置是所有守护进程都要配的：各个守护进程都<strong>必须</strong>指定 <code>host</code> ， Ceph 也要求指定监视器 IP 地址及端口。</p>
<div class="note note-danger">
            <p>一些部署工具（如 <code>ceph-deploy</code> 、 Chef ）会给你创建配置文件，如果它能胜任那就<strong>别设置</strong>这些值。</p>
          </div>
<div class="note note-primary">
            <p><code>host</code> 选项是主机的短名，不是全资域名 FQDN ，也<strong>不是</strong> IP 地址。在命令行下输入 <code>hostname -s</code> 获取主机名。</p>
          </div>
<pre><code class="hljs dust"><span class="xml">[mon.a]</span>

<span class="xml">        host = </span><span class="hljs-template-variable">&#123;hostname&#125;</span>
<span class="xml">        mon addr = </span><span class="hljs-template-variable">&#123;ip-address&#125;</span><span class="xml">:6789</span>

<span class="xml">[osd.0]</span>
<span class="xml">        host = </span><span class="hljs-template-variable">&#123;hostname&#125;</span></code></pre>
<p>并非一定要给守护进程设置 IP 地址。如果你有一个静态配置，且分离了公共网和集群网， Ceph 允许你在配置文件里指定主机的 IP 地址。要给守护进程设置静态 IP ，可把下列选项加到 <code>ceph.conf</code> 。</p>
<pre><code class="hljs armasm">[osd.<span class="hljs-number">0</span>]
        public <span class="hljs-keyword">addr</span> = &#123;host-public-<span class="hljs-built_in">ip</span>-address&#125;
        cluster <span class="hljs-keyword">addr</span> = &#123;host-cluster-<span class="hljs-built_in">ip</span>-address&#125;</code></pre>
<blockquote>
<p>单网卡OSD、双网络集群</p>
<p>一般来说，我们不建议用单网卡 OSD 主机部署两个网络。然而这事可以实现，把 <code>public addr</code> 选项配在 <code>[osd.n]</code> 段下即可强制 OSD 主机运行在公共网，其中 <code>n</code> 是其 OSD 号。另外，公共网和集群网必须互通，考虑到安全因素我们不建议这样做。</p>
</blockquote>
<h2 id="网络配置选项"><a href="#网络配置选项" class="headerlink" title="网络配置选项"></a>网络配置选项</h2><p>网络配置选项不是必需的， Ceph 假设所有主机都运行于公共网，除非你特意配置了一个集群网。</p>
<h3 id="公共网-1"><a href="#公共网-1" class="headerlink" title="公共网"></a>公共网</h3><p>公共网配置用于明确地为公共网定义 IP 地址和子网。你可以分配静态 IP 或用 <code>public addr</code> 覆盖 <code>public network</code> 选项。</p>
<p>public network</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>公共网（前端）的 IP 地址和掩码（如 <code>192.168.0.0/24</code> ），置于 <code>[global]</code> 下。多个子网用逗号分隔。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td><code>&#123;ip-address&#125;/&#123;netmask&#125; [, &#123;ip-address&#125;/&#123;netmask&#125;]</code></td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td>N/A</td>
</tr>
</tbody>
</table>
</div>
<p>public addr</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>用于公共网（前端）的 IP 地址。适用于各守护进程。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>IP 地址</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td>N/A</td>
</tr>
</tbody>
</table>
</div>
<h3 id="集群网-1"><a href="#集群网-1" class="headerlink" title="集群网"></a>集群网</h3><p>集群网配置用来声明一个集群网，并明确地定义其 IP 地址和子网。你可以配置静态 IP 或为某 OSD 守护进程配置 <code>cluster addr</code> 以覆盖 <code>cluster network</code> 选项。</p>
<p>cluster network</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>集群网（后端）的 IP 地址及掩码（如 <code>10.0.0.0/24</code> ），置于 <code>[global]</code> 下。多个子网用逗号分隔。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td><code>&#123;ip-address&#125;/&#123;netmask&#125; [, &#123;ip-address&#125;/&#123;netmask&#125;]</code></td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td>N/A</td>
</tr>
</tbody>
</table>
</div>
<p>cluster addr</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>集群网（后端） IP 地址。置于各守护进程下。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>Address</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td>N/A</td>
</tr>
</tbody>
</table>
</div>
<h3 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h3><p>绑定选项用于设置 OSD 和 MDS 默认使用的端口范围，默认范围是 <code>6800:7300</code> 。确保<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/network-config-ref/#id2">防火墙</a>开放了对应端口范围。</p>
<p>你也可以让 Ceph 守护进程绑定到 IPv6 地址。</p>
<p>ms bind port min</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>OSD 或 MDS 可绑定的最小端口号。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>32-bit Integer</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>6800</code></td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
</tbody>
</table>
</div>
<p>ms bind port max</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>OSD 或 MDS 可绑定的最大端口号。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>32-bit Integer</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>7300</code></td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No.</td>
</tr>
</tbody>
</table>
</div>
<p>ms bind ipv6</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>允许 Ceph 守护进程绑定 IPv6 地址。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>Boolean</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>false</code></td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
</tbody>
</table>
</div>
<h3 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h3><p>Ceph 配置文件里至少要写一个监视器、且每个监视器下都要配置 <code>mon addr</code> 选项；每个监视器、元数据服务器和 OSD 下都要配 <code>host</code> 选项。</p>
<p>mon addr</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th><code>&#123;hostname&#125;:&#123;port&#125;</code> 条目列表，用以让客户端连接 Ceph 监视器。如果未设置， Ceph 查找 <code>[mon.*]</code> 段。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>String</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td>N/A</td>
</tr>
</tbody>
</table>
</div>
<p>host</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>主机名。此选项用于特定守护进程，如 <code>[osd.0]</code> 。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>String</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>Yes, for daemon instances.</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>localhost</code></td>
</tr>
</tbody>
</table>
</div>
<p>不要用 <code>localhost</code> 。在命令行下执行 <code>hostname -s</code> 获取主机名（到第一个点，不是全资域名），并用于配置文件。</p>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>Ceph 默认禁用 TCP 缓冲。</p>
<p>ms tcp nodelay</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>Ceph 用 <code>ms tcp nodelay</code> 使系统尽快（不缓冲）发送每个请求。禁用 <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Nagle&#39;s_algorithm">Nagle 算法</a>可增加吞吐量，但会引进延时。如果你遇到大量小包，可以禁用 <code>ms tcp nodelay</code> 试试。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>Boolean</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>true</code></td>
</tr>
</tbody>
</table>
</div>
<p>ms tcp rcvbuf</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>网络套接字接收缓冲尺寸，默认禁用。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>32-bit Integer</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>0</code></td>
</tr>
</tbody>
</table>
</div>
<p>ms tcp read timeout</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">描述:</th>
<th>如果一客户端或守护进程发送请求到另一个 Ceph 守护进程，且没有断开不再使用的连接，在 <code>ms tcp read timeout</code> 指定的秒数之后它将被标记为空闲。</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">类型:</td>
<td>Unsigned 64-bit Integer</td>
</tr>
<tr>
<td style="text-align:left">是否必需:</td>
<td>No</td>
</tr>
<tr>
<td style="text-align:left">默认值:</td>
<td><code>900</code> 15 minutes.</td>
</tr>
</tbody>
</table>
</div>
<h2 id="认证选项"><a href="#认证选项" class="headerlink" title="认证选项"></a>认证选项</h2><p><code>cephx</code> 协议已默认开启。加密认证要耗费一定计算资源，但通常很低。如果您的客户端和服务器网络环境相当安全，而且认证的负面效应更大，你可以关闭它，<strong>通常不推荐您这么做</strong>。</p>
<p>使用ceph-deploy会自动创建认证信息：</p>
<pre><code class="hljs ini"><span class="hljs-attr">auth_cluster_required</span> = cephx
<span class="hljs-attr">auth_service_required</span> = cephx
<span class="hljs-attr">auth_client_required</span> = cephx</code></pre>
<p>当执行<code>ceph-deploy mon create-initial</code>，ceph会引导初始监视器，返回一个<code>ceph.client.admin.keyring</code>文件。</p>
<p>当执行 <code>ceph-deploy admin &#123;node-name&#125;</code>，你相当于把<code>ceph.client.admin.keyring</code>文件放在节点的/etc/ceph目录下。</p>
<h3 id="启用-CEPHX"><a href="#启用-CEPHX" class="headerlink" title="启用 CEPHX"></a>启用 CEPHX</h3><p>启用 <code>cephx</code> 后， Ceph 将在默认搜索路径（包括 <code>/etc/ceph/ceph.$name.keyring</code> ）里查找密钥环。你可以在 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/ceph-conf">Ceph 配置</a>文件的 <code>[global]</code> 段里添加 <code>keyring</code> 选项来修改，但不推荐。</p>
<p>在禁用了 <code>cephx</code> 的集群上执行下面的步骤来启用它，如果你（或者部署工具）已经生成了密钥，你可以跳过相关步骤。</p>
<ol>
<li><p>创建 <code>client.admin</code> 密钥，并为客户端保存此密钥的副本：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">auth </span><span class="hljs-built_in">get-or-create</span> <span class="hljs-string">client.</span><span class="hljs-string">admin </span><span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-string">mds </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-string">osd </span><span class="hljs-string">&#x27;allow *&#x27;</span> -o /<span class="hljs-string">etc/</span><span class="hljs-string">ceph/</span><span class="hljs-string">ceph.</span><span class="hljs-string">client.</span><span class="hljs-string">admin.</span><span class="hljs-string">keyring</span></code></pre>
<div class="note note-danger">
            <p><strong>警告：</strong> 此命令会覆盖任何存在的 <code>/etc/ceph/client.admin.keyring</code> 文件，如果部署工具已经完成此步骤，千万别再执行此命令。多加小心！</p>
          </div>
</li>
<li><p>创建监视器集群所需的密钥环、并给它们生成密钥。</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph-authtool </span><span class="hljs-built_in">--create-keyring</span> /<span class="hljs-string">tmp/</span><span class="hljs-string">ceph.</span><span class="hljs-string">mon.</span><span class="hljs-string">keyring </span><span class="hljs-built_in">--gen-key</span> -n <span class="hljs-string">mon.</span> <span class="hljs-built_in">--cap</span> <span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow *&#x27;</span></code></pre>
</li>
<li><p>把监视器密钥环复制到 <code>ceph.mon.keyring</code> 文件，再把此文件复制到各监视器的 <code>mon data</code> 目录下。比如要把它复制给名为 <code>ceph</code> 集群的 <code>mon.a</code> ，用此命令：</p>
<pre><code class="hljs crystal">cp /tmp/ceph.mon.keyring /var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/<span class="hljs-title">mon</span>/<span class="hljs-title">ceph</span>-<span class="hljs-title">a</span>/<span class="hljs-title">keyring</span></span></code></pre>
</li>
<li><p>为每个 OSD 生成密钥， <code>&#123;$id&#125;</code> 是 OSD 编号：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">auth </span><span class="hljs-built_in">get-or-create</span> <span class="hljs-string">osd.</span>&#123;$<span class="hljs-string">id&#125;</span> <span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow rwx&#x27;</span> <span class="hljs-string">osd </span><span class="hljs-string">&#x27;allow *&#x27;</span> -o /<span class="hljs-string">var/</span><span class="hljs-string">lib/</span><span class="hljs-string">ceph/</span><span class="hljs-string">osd/</span><span class="hljs-string">ceph-</span>&#123;$<span class="hljs-string">id&#125;</span>/<span class="hljs-string">keyring</span></code></pre>
</li>
<li><p>为每个 MDS 生成密钥， <code>&#123;$id&#125;</code> 是 MDS 的标识字母：</p>
<pre><code class="hljs dsconfig"><span class="hljs-string">ceph </span><span class="hljs-string">auth </span><span class="hljs-built_in">get-or-create</span> <span class="hljs-string">mds.</span>&#123;$<span class="hljs-string">id&#125;</span> <span class="hljs-string">mon </span><span class="hljs-string">&#x27;allow rwx&#x27;</span> <span class="hljs-string">osd </span><span class="hljs-string">&#x27;allow *&#x27;</span> <span class="hljs-string">mds </span><span class="hljs-string">&#x27;allow *&#x27;</span> -o /<span class="hljs-string">var/</span><span class="hljs-string">lib/</span><span class="hljs-string">ceph/</span><span class="hljs-string">mds/</span><span class="hljs-string">ceph-</span>&#123;$<span class="hljs-string">id&#125;</span>/<span class="hljs-string">keyring</span></code></pre>
</li>
<li><p>把以下配置加入 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/ceph-conf">Ceph 配置</a>文件的 <code>[global]</code> 段下以启用 <code>cephx</code> 认证：</p>
<pre><code class="hljs routeros">auth cluster required = cephx
auth<span class="hljs-built_in"> service </span>required = cephx
auth<span class="hljs-built_in"> client </span>required = cephx</code></pre>
</li>
<li><p>启动或重启 Ceph 集群，详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/operating">操纵集群</a>。</p>
</li>
</ol>
<h3 id="禁用-CEPHX"><a href="#禁用-CEPHX" class="headerlink" title="禁用 CEPHX"></a>禁用 CEPHX</h3><p>下述步骤描述了如何禁用 Cephx 。如果你的集群环境相对安全，你可以减免认证耗费的计算资源，然而<strong>我们不推荐</strong>。但是临时禁用认证会使安装、和/或排障更简单。</p>
<ol>
<li><p>把下列配置加入 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/ceph-conf">Ceph 配置</a>文件的 <code>[global]</code> 段下即可禁用 <code>cephx</code> 认证：</p>
<pre><code class="hljs routeros">auth cluster required = none
auth<span class="hljs-built_in"> service </span>required = none
auth<span class="hljs-built_in"> client </span>required = none</code></pre>
</li>
<li><p>启动或重启 Ceph 集群，具体参考<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/operating">操纵集群</a>。</p>
</li>
</ol>
<h3 id="密钥"><a href="#密钥" class="headerlink" title="密钥"></a>密钥</h3><p>如果你的集群启用了认证， <code>ceph</code> 管理命令和客户端得有密钥才能访问集群。</p>
<p>给 <code>ceph</code> 管理命令和客户端提供密钥的最常用方法就是把密钥环放到 <code>/etc/ceph</code> ，通过 <code>ceph-deploy</code> 部署的 Cuttlefish 及更高版本，其文件名通常是 <code>ceph.client.admin.keyring</code> （或 <code>$cluster.client.admin.keyring</code> ）。如果你的密钥环位于 <code>/etc/ceph</code> 下，就不需要在 Ceph 配置文件里指定 <code>keyring</code> 选项了。</p>
<p>我们建议把集群的密钥环复制到你执行管理命令的节点，它包含 <code>client.admin</code> 密钥。</p>
<p>你可以用 <code>ceph-deploy admin</code> 命令做此事，详情见’部署管理主机’_，手动复制可执行此命令：</p>
<pre><code class="hljs roboconf">sudo scp &#123;<span class="hljs-attribute">user&#125;@&#123;ceph-cluster-host&#125;</span>:/etc/ceph/ceph<span class="hljs-variable">.client</span><span class="hljs-variable">.admin</span><span class="hljs-variable">.keyring</span> /etc/ceph/ceph<span class="hljs-variable">.client</span><span class="hljs-variable">.admin</span><span class="hljs-variable">.keyring</span></code></pre>
<div class="note note-primary">
            <p>确保给客户端上的 <code>ceph.keyring</code> 设置合理的权限位（如 <code>chmod 644</code> ）</p>
          </div>
<p>守护进程数据目录位置默认格式如下：</p>
<pre><code class="hljs crystal">/var/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">ceph</span>/$<span class="hljs-title">type</span>/$<span class="hljs-title">cluster</span>-$<span class="hljs-title">id</span></span></code></pre>
<h2 id="MONITOR-配置"><a href="#MONITOR-配置" class="headerlink" title="MONITOR 配置"></a>MONITOR 配置</h2><p><span id ="MONITOR"> 这儿</span></p>
<p>监视器们维护着集群运行图的“主副本”，就是说<strong>客户端连到一个监视器并获取当前运行图就能确定所有监视器、 OSD 和元数据服务器的位置</strong>。 Ceph 客户端读写 OSD 或元数据服务器前，必须先连到一个监视器，靠当前集群运行图的副本和 CRUSH 算法，客户端能计算出任何对象的位置，故此客户端有能力直接连到 OSD ，这对 Ceph 的高伸缩性、高性能来说非常重要。更多信息见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/architecture#scalability-and-high-availability">伸缩性和高可用性</a>。</p>
<p>监视器的主要角色是维护集群运行图的主副本，它也提供<strong>认证</strong>和<strong>日志记录</strong>服务。 Ceph 监视器们把监视器服务的所有更改写入一个单独的 <strong>Paxos</strong> 例程，然后 Paxos 以键/值方式存储所有变更以实现高度一致性。同步期间， Ceph 监视器能查询集群运行图的近期版本，它们通过操作键/值存储快照和迭代器（用 leveldb ）来进行存储级同步。</p>
<p><img src="\img\ceph-mon.png" srcset="/img/loading.gif" alt="img"></p>
<h3 id="集群运行图"><a href="#集群运行图" class="headerlink" title="集群运行图"></a>集群运行图</h3><p>集群运行图是多个图的组合，包括监视器图、 OSD 图、归置组图和元数据服务器图。集群运行图追踪几个重要事件：哪些进程在集群里（ <code>in</code> ）；哪些进程在集群里（ <code>in</code> ）是 <code>up</code> 且在运行、或 <code>down</code> ；归置组状态是 <code>active</code> 或 <code>inactive</code> 、 <code>clean</code> 或其他状态；和其他反映当前集群状态的信息，像总存储容量、和使用量。</p>
<p>当集群状态有明显变更时，如一 OSD 挂了、一归置组降级了等等，集群运行图会被更新以反映集群当前状态。另外，监视器也维护着集群的主要状态历史。监视器图、 OSD 图、归置组图和元数据服务器图各自维护着它们的运行图版本。我们把各图的版本称为一个 epoch 。</p>
<p>运营集群时，跟踪这些状态是系统管理任务的重要部分。详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/monitoring">监控集群</a>和<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/operations/monitoring-osd-pg">监控 OSD 和归置组</a>。</p>
<h3 id="监视器法定人数（Quorum）"><a href="#监视器法定人数（Quorum）" class="headerlink" title="监视器法定人数（Quorum）"></a>监视器法定人数（Quorum）</h3><p>简单的Ceph-deploy只会配置一台monitor，而这很容易造成单点故障。Ceph采用<strong>Paxos</strong>来保证集群运行一致性。这里的一致要求大多数监视器都在运行且够成法定人数（如 1 个、 3 之 2 在运行、 5 之 3 、 6 之 4 等等）。</p>
<h3 id="一致性"><a href="#一致性" class="headerlink" title="一致性"></a>一致性</h3><p>你把监视器加进 Ceph 配置文件时，得注意一些架构问题， Ceph 发现集群内的其他监视器时对其有着<strong>严格的一致性要求</strong>。尽管如此， Ceph 客户端和其他 Ceph 守护进程用配置文件发现监视器，监视器却用监视器图（ monmap ）相互发现而非配置文件。</p>
<p>一个监视器发现集群内的其他监视器时总是参考 <strong>monmap</strong> 的本地副本，用 monmap 而非 Ceph 配置文件避免了可能损坏集群的错误（如 <code>ceph.conf</code> 中指定地址或端口的拼写错误）。正因为监视器把 monmap 用于发现、并共享于客户端和其他 Ceph 守护进程间， <strong>monmap可严格地保证监视器的一致性是可靠的</strong>。</p>
<p>严格的一致性也适用于 monmap 的更新，因为关于监视器的任何更新、关于 monmap 的变更都是通过称为 <a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Paxos_(computer_science">Paxos</a>) 的分布式一致性算法传递的。监视器们必须就 monmap 的每次更新达成一致，以确保法定人数里的每个监视器 monmap 版本相同，如增加、删除一个监视器。 monmap 的更新是增量的，所以监视器们都有最新的一致版本，以及一系列之前版本。历史版本的存在允许一个落后的监视器跟上集群当前状态。</p>
<h3 id="初始化监视器"><a href="#初始化监视器" class="headerlink" title="初始化监视器"></a>初始化监视器</h3><p>在大多数配置和部署案例中，部署 Ceph 的工具可以帮你生成一个监视器图来初始化监视器（如 <code>ceph-deploy</code> 等），一个监视器需要 若干个选项：</p>
<p><strong>惟一标识符：</strong> <code>fsid</code> 是集群的惟一标识，它是 Ceph 作为文件系统时的文件系统标识符。现在， Ceph 还支持原生接口、块设备、和对象存储网关接口，所以 <code>fsid</code> 有点名不符实了。</p>
<p><strong>集群名称：</strong> 每个 Ceph 集群都有自己的名字，它是个不含空格的字符串。默认名字是 <code>ceph</code> 、但你可以更改；尤其是运营着多个集群时，需要用名字来区分要操作哪一个。比如，当你以<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/radosgw/federated-config">联盟架构</a>运营多个集群时，集群名字（如 <code>us-west</code> 、 <code>us-east</code> ）将作为标识符出现在 CLI 界面上。<strong>注意：</strong>要在命令行下指定某个集群，可以指定以集群名为前缀的配置文件（如 <code>ceph.conf</code> 、 <code>us-west.conf</code> 、 <code>us-east.conf</code> 等）；也可以参考 CLI 用法（ <code>ceph --cluster &#123;cluster-name&#125;</code> ）。</p>
<p><strong>监视器名字：</strong> 同一集群内的各监视器例程都有惟一的名字，通常都用主机名作为监视器名字（我们建议每台主机只运行一个监视器、并且不要与 OSD 主机复用。短主机名可以用 <code>hostname -s</code> 获取。</p>
<p><strong>监视器图：</strong> 自举引导初始监视器需要生成监视器图，为此，需要有 <code>fsid</code> 、集群名（或用默认）、至少一个主机名及其 IP 。</p>
<p><strong>监视器密钥环：</strong> 监视器之间通过密钥通讯，所以你必须把监视器密钥加入密钥环，并在自举引导时提供。</p>
<p><strong>管理密钥环：</strong> 要使用 <code>ceph</code> 这个命令行工具，你必须有 <code>client.admin</code> 用户，所以你要创建此用户及其密钥，并把他们加入密钥环。</p>
<p>关于初始化的具体信息见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/dev/mon-bootstrap">初始化监视器</a>。</p>
<pre><code class="hljs angelscript">[mon]
        mon host = hostname1,hostname2,hostname3
        mon addr = <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.10</span>:<span class="hljs-number">6789</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.11</span>:<span class="hljs-number">6789</span>,<span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>:<span class="hljs-number">6789</span></code></pre>
<h3 id="初始成员"><a href="#初始成员" class="headerlink" title="初始成员"></a>初始成员</h3><p>我们建议在生产环境下最少部署 3 个监视器，以确保高可用性。运行多个监视器时，你可以指定为形成法定人数成员所需的初始监视器，这能减小集群上线时间。</p>
<pre><code class="hljs csharp">[<span class="hljs-meta">mon</span>]
        mon initial members = a,b,c</code></pre>
<div class="note note-primary">
            <p>Ceph 需要奇数个监视器来确定最初法定人数（如 3 ）。</p>
          </div>
<h3 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h3><p>Ceph 监视器有存储数据的默认路径，生产集群为实现更高性能可把监视器部署到非 OSD 节点的独立主机上。因为监视器会频繁 <code>fsync()</code> ，这可能影响 OSD 。</p>
<h3 id="存储容量"><a href="#存储容量" class="headerlink" title="存储容量"></a>存储容量</h3><p>Ceph 存储集群利用率接近最大容量时（即 <code>mon osd full ratio</code> ），作为防止数据丢失的安全措施，它会阻止你读写 OSD 。因此，让生产集群用满可不是好事，因为牺牲了高可用性。 full ratio 默认值是 <code>.95</code> 或容量的 95% 。对小型测试集群来说这是非常激进的设置。</p>
<div class="note note-primary">
            <p>监控集群时，要警惕和 <code>nearfull</code> 相关的警告。这意味着一些 OSD 的失败会导致临时服务中断，应该增加一些 OSD 来扩展存储容量。</p>
          </div>
<p>在测试集群时，一个常见场景是：系统管理员从集群删除一个 OSD 、接着观察重均衡；然后继续删除其他 OSD ，直到集群达到占满率并锁死。我们建议，即使在测试集群里也要规划一点空闲容量用于保证高可用性。理想情况下，要做好这样的预案：一系列 OSD 失败后，短时间内不更换它们仍能恢复到 <code>active + clean</code> 状态。你也可以在 <code>active + degraded</code> 状态运行集群，但对正常使用来说并不好。找出你集群的两个数字：</p>
<ol>
<li>OSD 数量。</li>
<li>集群总容量</li>
</ol>
<p>用集群里 OSD 总数除以集群总容量，就能得到 OSD 平均容量；如果按预计的 OSD 数乘以这个值所得的结果计算（偏小），实际应用时将出错；最后再用集群容量乘以占满率能得到最大运行容量，然后扣除预估的 OSD 失败率；用较高的失败率（如整机架的 OSD ）重复前述过程看是否接近占满率。</p>
<pre><code class="hljs jboss-cli">[global]
		<span class="hljs-comment"># 在OSDconsidered full之前的磁盘空间使用率</span>
		mon osd full ratio = <span class="hljs-string">.80</span>
	    <span class="hljs-comment"># OSD 硬盘使用率达到多少就认为它 full 。</span>
        mon osd full ratio = <span class="hljs-string">.80</span>
        <span class="hljs-comment">#	OSD 硬盘使用率达到多少就认为它 nearfull 。</span>
        mon osd nearfull ratio = <span class="hljs-string">.70</span></code></pre>
<div class="note note-primary">
            <p>如果一些 OSD 快满了，但其他的仍有足够空间，你可能配错 CRUSH 权重了。</p>
          </div>
<h3 id="心跳"><a href="#心跳" class="headerlink" title="心跳"></a>心跳</h3><p>Ceph 监视器要求各 OSD 向它报告、并接收 OSD 们的邻居状态报告，以此来掌握集群。 Ceph 提供了监视器与 OSD 交互的合理默认值，然而你可以按需修改，详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/mon-osd-interaction">监视器与 OSD 的交互</a>。</p>
<h3 id="监视器存储同步"><a href="#监视器存储同步" class="headerlink" title="监视器存储同步"></a>监视器存储同步</h3><p>当你用多个监视器支撑一个生产集群时，各监视器都要检查邻居是否有集群运行图的最新版本（如，邻居监视器的图有一或多个 epoch 版本高于当前监视器的最高版 epoch ），过一段时间，集群里的某个监视器可能落后于其它监视器太多而不得不离开法定人数，然后同步到集群当前状态，并重回法定人数。为了同步，监视器可能承担三种中的一种角色：</p>
<ol>
<li><strong>Leader</strong>: Leader 是实现最新 Paxos 版本的第一个监视器。</li>
<li><strong>Provider</strong>: Provider 有最新集群运行图的监视器，但不是第一个实现最新版。</li>
<li><strong>Requester:</strong> Requester 落后于 leader ，重回法定人数前，必须同步以获取关于集群的最新信息。</li>
</ol>
<p>有了这些角色区分， leader就 可以给 provider 委派同步任务，这会避免同步请求压垮 leader 、影响性能。在下面的图示中， requester 已经知道它落后于其它监视器，然后向 leader 请求同步， leader 让它去和 provider 同步。</p>
<hr>
<p><img src="\img\ceph-mon2.png" srcset="/img/loading.gif" alt="img"></p>
<p>一旦同步完成， Ceph 需要修复整个集群，使归置组回到 <code>active + clean</code> 状态。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Descrip.</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>mon sync timeout</td>
<td>Number of seconds the monitor will wait for the next update message from its sync provider before it gives up and bootstrap again.</td>
<td>Double</td>
<td>60.0</td>
</tr>
<tr>
<td>mon sync max payload size</td>
<td>The maximum size for a sync payload (in bytes).</td>
<td>32-bit Integer</td>
<td>1048576</td>
</tr>
<tr>
<td>paxos max join drift</td>
<td>The maximum Paxos iterations before we must first sync the monitor data stores. When a monitor finds that its peer is too far ahead of it, it will first sync with data stores before moving on.</td>
<td>Integer</td>
<td>10</td>
</tr>
<tr>
<td>paxos stash full interval</td>
<td>How often (in commits) to stash a full copy of the PaxosService state. Current this setting only affects <code>mds</code>, <code>mon</code>, <code>auth</code> and <code>mgr</code> PaxosServices.</td>
<td>Integer</td>
<td>25</td>
</tr>
<tr>
<td>paxos propose interval</td>
<td>Gather updates for this time interval before proposing a map update.</td>
<td>Double</td>
<td>1.0</td>
</tr>
<tr>
<td>paxos min</td>
<td>The minimum number of paxos states to keep around</td>
<td>Integer</td>
<td>500</td>
</tr>
<tr>
<td>paxos min wait</td>
<td>The minimum amount of time to gather updates after a period of inactivity.</td>
<td>Double</td>
<td>0.05</td>
</tr>
<tr>
<td>paxos trim min</td>
<td>Number of extra proposals tolerated before trimming</td>
<td>Integer</td>
<td>250</td>
</tr>
<tr>
<td>paxos trim max</td>
<td>The maximum number of extra proposals to trim at a time</td>
<td>Integer</td>
<td>500</td>
</tr>
<tr>
<td>paxos service trim min</td>
<td>The minimum amount of versions to trigger a trim (0 disables it)</td>
<td>Integer</td>
<td>250</td>
</tr>
<tr>
<td>paxos service trim max</td>
<td>The maximum amount of versions to trim during a single proposal (0 disables it)</td>
<td>Integer</td>
<td>500</td>
</tr>
<tr>
<td>mon mds force trim to</td>
<td>Force monitor to trim mdsmaps to this point (0 disables it. dangerous, use with care)</td>
<td>Integer</td>
<td>0</td>
</tr>
<tr>
<td>mon osd force trim to</td>
<td>Force monitor to trim osdmaps to this point, even if there is PGs not clean at the specified epoch (0 disables it. dangerous, use with care)</td>
<td>Integer</td>
<td>0</td>
</tr>
<tr>
<td>mon osd cache size</td>
<td>The size of osdmaps cache, not to rely on underlying store’s cache</td>
<td>Integer</td>
<td>500</td>
</tr>
<tr>
<td>mon election timeout</td>
<td>On election proposer, maximum waiting time for all ACKs in seconds.</td>
<td>Float</td>
<td>5.00</td>
</tr>
<tr>
<td>mon lease</td>
<td>The length (in seconds) of the lease on the monitor’s versions.</td>
<td>Float</td>
<td>5.00</td>
</tr>
<tr>
<td>mon lease renew interval factor</td>
<td><code>mon lease</code> * <code>mon lease renew interval factor</code> will be the interval for the Leader to renew the other monitor’s leases. The factor should be less than <code>1.0</code>.</td>
<td>Float</td>
<td>0.60</td>
</tr>
<tr>
<td>mon lease ack timeout factor</td>
<td>The Leader will wait <code>mon lease</code> * <code>mon lease ack timeout factor</code> for the Providers to acknowledge the lease extension.</td>
<td>Float</td>
<td>2.00</td>
</tr>
<tr>
<td>mon accept timeout factor</td>
<td>The Leader will wait <code>mon lease</code> * <code>mon accept timeout factor</code> for the Requester(s) to accept a Paxos update. It is also used during the Paxos recovery phase for similar purposes.</td>
<td>Float</td>
<td>2.00</td>
</tr>
<tr>
<td>mon min osdmap epochs</td>
<td>Minimum number of OSD map epochs to keep at all times.</td>
<td>32-bit Integer</td>
<td>500</td>
</tr>
<tr>
<td>mon max log epochs</td>
<td>Maximum number of Log epochs the monitor should keep.</td>
<td>32-bit Integer</td>
<td>500</td>
</tr>
</tbody>
</table>
</div>
<h3 id="时钟"><a href="#时钟" class="headerlink" title="时钟"></a>时钟</h3><p>Ceph 的守护进程会相互传递关键消息，这些消息必须在达到超时阀值前处理掉。如果 Ceph 监视器时钟不同步，就可能出现多种异常情况。例如：</p>
<ul>
<li>守护进程忽略了收到的消息（如时间戳过时了）</li>
<li>消息未及时收到时，超时触发得太快或太晚。</li>
</ul>
<p>详情见<a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/mon-config-ref/#id13">监视器存储同步</a>和 <a target="_blank" rel="noopener" href="http://docs.ceph.org.cn/rados/configuration/mon-config-ref/#slurp">Slurp</a> 。</p>
<p>为了避免实际漂移建议安装<code>NTP</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Descrip.</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>mon tick interval</td>
<td>A monitor’s tick interval in seconds.</td>
<td>32-bit Integer</td>
<td>5</td>
</tr>
<tr>
<td>mon clock drift allowed</td>
<td>The clock drift in seconds allowed between monitors.</td>
<td>Float</td>
<td>0.05</td>
</tr>
<tr>
<td>mon clock drift warn backoff</td>
<td>Exponential backoff for clock drift warnings</td>
<td>Float</td>
<td>5.00</td>
</tr>
<tr>
<td>mon timecheck interval</td>
<td>The time check interval (clock drift check) in seconds for the Leader.</td>
<td>Float</td>
<td>300.0</td>
</tr>
<tr>
<td>mon timecheck skew interval</td>
<td>The time check interval (clock drift check) in seconds when in presence of a skew in seconds for the Leader.</td>
<td>Float</td>
<td>30.0</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2></li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Descrip.</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>mon client hunt interval</td>
<td>The client will try a new monitor every <code>N</code> seconds until it establishes a connection.</td>
<td>Double</td>
<td>3.00</td>
</tr>
<tr>
<td>mon client ping interval</td>
<td>The client will ping the monitor every <code>N</code> seconds.</td>
<td>Double</td>
<td>10.00</td>
</tr>
<tr>
<td>mon client max log entries per message</td>
<td>The maximum number of log entries a monitor will generate per client message.</td>
<td>Integer</td>
<td>1000</td>
</tr>
<tr>
<td>mon client bytes</td>
<td>The amount of client message data allowed in memory (in bytes).</td>
<td>64-bit Integer Unsigned</td>
<td>100ul &lt;&lt; 20</td>
</tr>
</tbody>
</table>
</div>
<h2 id="Pool-Settings"><a href="#Pool-Settings" class="headerlink" title="Pool Settings"></a>Pool Settings</h2><div class="table-container">
<table>
<thead>
<tr>
<th>Parameters</th>
<th>Descrip.</th>
<th>Type</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>mon allow pool delete</td>
<td>If the monitors should allow pools to be removed. Regardless of what the pool flags say.</td>
<td>Boolean</td>
<td>false</td>
</tr>
<tr>
<td>osd pool default ec fast read</td>
<td>Whether to turn on fast read on the pool or not. It will be used as the default setting of newly created erasure coded pools if <code>fast_read</code> is not specified at create time.</td>
<td>Boolean</td>
<td>false</td>
</tr>
<tr>
<td>osd pool default flag hashpspool</td>
<td>Set the hashpspool flag on new pools</td>
<td>Boolean</td>
<td>true</td>
</tr>
<tr>
<td>osd pool default flag nodelete</td>
<td>Set the nodelete flag on new pools. Prevents allow pool removal with this flag in any way.</td>
<td>Boolean</td>
<td>false</td>
</tr>
<tr>
<td>osd pool default flag nopgchange</td>
<td>Set the nopgchange flag on new pools. Does not allow the number of PGs to be changed for a pool.</td>
<td>Boolean</td>
<td>false</td>
</tr>
<tr>
<td>osd pool default flag nosizechange</td>
<td>Set the nosizechange flag on new pools. Does not allow the size to be changed of pool.</td>
<td>Boolean</td>
<td>false</td>
</tr>
</tbody>
</table>
</div>
<p>For more information about the pool flags see <a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/operations/pools/#set-pool-values">Pool values</a>.</p>
<hr>
<h2 id="Miscellaneous¶"><a href="#Miscellaneous¶" class="headerlink" title="Miscellaneous¶"></a>Miscellaneous<a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/rados/configuration/mon-config-ref/#miscellaneous">¶</a></h2><p>Please click… the link icon.</p>
<h2 id="文档编译"><a href="#文档编译" class="headerlink" title="文档编译"></a>文档编译</h2><p>安装和使用</p>
<pre><code class="hljs sql">sudo apt-get <span class="hljs-keyword">install</span> cat doc_deps.deb.txt
<span class="hljs-keyword">admin</span>/<span class="hljs-keyword">build</span>-doc</code></pre>
<hr>
<h2 id="加速本地编译"><a href="#加速本地编译" class="headerlink" title="加速本地编译"></a>加速本地编译</h2><p><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/latest/dev/developer_guide/essentials/#using-ccache-to-speed-up-local-builds">https://docs.ceph.com/en/latest/dev/developer_guide/essentials/#using-ccache-to-speed-up-local-builds</a></p>
<h1 id="为ceph社区做出自己的贡献"><a href="#为ceph社区做出自己的贡献" class="headerlink" title="为ceph社区做出自己的贡献"></a>为ceph社区做出自己的贡献</h1><p>Mailing list</p>
<p>The <code>dev@ceph.io</code> list is for discussion about the development of Ceph, its interoperability with other technology, and the operations of the project itself. Subscribe by sending a message to <code>dev-request@ceph.io</code> with the line:</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">subscribe ceph-devel</span></code></pre>
<p>in the body of the message.</p>
<p>The <a href="mailto:ceph-devel%40vger.kernel.org">ceph-devel@vger.kernel.org</a> list is for discussion and patch review for the Linux kernel Ceph client component. Subscribe by sending a message to <code>majordomo@vger.kernel.org</code> with the line:</p>
<pre><code class="hljs ebnf"><span class="hljs-attribute">subscribe ceph-devel</span></code></pre>
<p>in the body of the message.</p>
<hr>
<h1 id="Trouble-Shooting-Runtime"><a href="#Trouble-Shooting-Runtime" class="headerlink" title="Trouble Shooting: Runtime"></a>Trouble Shooting: Runtime</h1><ol>
<li><pre><code class="hljs apache"><span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>.<span class="hljs-number">856064</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind unable to bind to <span class="hljs-number">101.67.163.20:6789</span>: (<span class="hljs-number">99</span>) Cannot assign requested address
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>.<span class="hljs-number">856085</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind was unable to bind. Trying again in <span class="hljs-number">5</span> seconds
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">52</span>.<span class="hljs-number">856281</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind unable to bind to <span class="hljs-number">101.67.163.20:6789</span>: (<span class="hljs-number">99</span>) Cannot assign requested address
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">52</span>.<span class="hljs-number">856319</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind was unable to bind. Trying again in <span class="hljs-number">5</span> seconds
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">57</span>.<span class="hljs-number">856622</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind unable to bind to <span class="hljs-number">101.67.163.20:6789</span>: (<span class="hljs-number">99</span>) Cannot assign requested address
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">57</span>.<span class="hljs-number">856657</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> accepter.accepter.bind was unable to bind after <span class="hljs-number">3</span> attempts: (<span class="hljs-number">99</span>) Cannot assign requested address
<span class="hljs-attribute">2015</span>-<span class="hljs-number">11</span>-<span class="hljs-number">23</span> <span class="hljs-number">13</span>:<span class="hljs-number">23</span>:<span class="hljs-number">57</span>.<span class="hljs-number">856670</span> <span class="hljs-number">7</span>f<span class="hljs-number">4</span>a<span class="hljs-number">5</span>a<span class="hljs-number">36</span>a<span class="hljs-number">7</span>a<span class="hljs-number">0</span> -<span class="hljs-number">1</span> unable to bind monitor to <span class="hljs-number">101.67.163.20:6789</span>/<span class="hljs-number">0</span>
<span class="hljs-attribute">failed</span>: &#x27;ssh ceph-<span class="hljs-number">10</span> ulimit -n <span class="hljs-number">32768</span>;  /usr/bin/ceph-mon -i a --pid-file /var/run/ceph/mon.a.pid -c /etc/ceph/ceph.conf --cluster ceph &#x27;
</code></pre>
</li>
</ol>
<p>这是由于ip地址更换的原因，检查一下。</p>
<p>2.</p>
<p>sudo 执行很慢，可以改/etc/hosts </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mouseleo/p/9302301.html">https://www.cnblogs.com/mouseleo/p/9302301.html</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/ceph/">ceph</a>
                    
                      <a class="hover-with-bg" href="/categories/ceph/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">分布式存储</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">系统架构</a>
                    
                      <a class="hover-with-bg" href="/tags/ceph/">ceph</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/10/24/CMake%20%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8D%97/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Cmake学习</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/10/18/VIMdict/">
                        <span class="hidden-mobile">VIM命令查询</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "8oX7VCxy9tyFQIvF8qwLorP0-gzGzoHsz",
          app_key: "F0939INl4cKXpCw2HgTIUb6B",
          placeholder: "说点什么,（支持Markdown）",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "https://8ox7vcxy.lc-cn-n1-shared.com",
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a target="_blank" href="https://valine.js.org" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "【高级部署】Ceph手动配置集群部署&编译源码&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>







  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  








  <script  src="https://cdn.staticfile.org/mermaid/8.5.0/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>




  

  

  

  

  

  





<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>

</body>
</html>
